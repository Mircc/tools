<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPDNS/DNS ç»Ÿä¸€éªŒè¯å·¥å…· (å…¨çƒä¸°å¯ŒèŠ‚ç‚¹ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: #334155;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #1e293b; text-align: center; margin-bottom: 20px; }
        h2 { font-size: 1.1rem; margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* è¾“å…¥ä¸æŸ¥è¯¢æ  - é¡¶è¡Œå¸ƒå±€ */
        .query-box-top { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        
        .input-group { width: 100%; }
        /* é’ˆå¯¹é¡¶è¡ŒåŸŸåè¾“å…¥æ¡†çš„å®½åº¦ */
        .domain-group { flex-grow: 1; } 
        
        .input-group label { display: block; font-size: 0.9em; font-weight: 600; margin-bottom: 5px; color: #475569; }

        input[type="text"] {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 6px;
            font-size: 14px; font-family: monospace; box-sizing: border-box;
        }
        input[type="text"]:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
            height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

        /* éšè—çš„è‡ªå®šä¹‰æœåŠ¡å™¨è¾“å…¥æ¡†æ ·å¼ */
        #customServerWrapper {
            transition: opacity 0.3s ease;
            opacity: 0; /* é»˜è®¤ä½¿ç”¨ opacity 0 å’Œ display none é…åˆåšå¹³æ»‘è¿‡æ¸¡ */
            margin-top: -5px; /* ç¨å¾®å‘ä¸Šè°ƒæ•´ï¼Œå‡å°‘åˆå§‹é—´è· */
            padding-top: 10px;
        }
        
        /* è¡¨æ ¼æ ·å¼ä¿æŒä¸å˜ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 0.9em; font-weight: 600; }
        td { padding: 12px; border-top: 1px solid var(--border); vertical-align: middle; }
        
        .status-badge {
            display: inline-flex; align-items: center; padding: 4px 8px;
            border-radius: 99px; font-size: 12px; font-weight: 600;
        }
        .st-wait { background: #f1f5f9; color: #64748b; }
        .st-ok { background: #dcfce7; color: #15803d; }
        .st-err { background: #fee2e2; color: #b91c1c; }
        
        .ip-list { font-family: monospace; font-weight: bold; color: #0f172a; }
        .meta-info { font-size: 0.85em; color: #94a3b8; margin-top: 4px; }

        .tips { font-size: 0.9em; color: #64748b; background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f97316; }
    </style>
</head>
<body>

<div class="container">
    <h1>HTTPDNS/DNS ç»Ÿä¸€éªŒè¯å·¥å…·</h1>

    <div class="card">
        
        <div class="query-box-top">
            <div class="input-group domain-group">
                <label for="domainInput">è¦æŸ¥è¯¢çš„åŸŸå (ä¾‹å¦‚: www.baidu.com)</label>
                <input type="text" id="domainInput" value="www.google.com" placeholder="è¯·è¾“å…¥åŸŸå">
            </div>
            
            <button class="btn btn-primary" id="queryBtn" onclick="startQuery()">ğŸš€ å¼€å§‹æŸ¥è¯¢</button>
        </div>
        
        <div id="customServerWrapper" style="display: none; opacity: 0;">
            <div class="input-group">
                <label for="customServerInput">è‡ªå®šä¹‰ DNS/HTTPDNS æœåŠ¡å™¨ (IP æˆ– URL)</label>
                <input type="text" id="customServerInput" placeholder="ä¾‹å¦‚: 8.8.8.8 æˆ– https://dns.digitale-gesellschaft.ch/dns-query">
            </div>
        </div>
    </div>
    
    <div class="tips">
        <strong>âš ï¸ ä¼ ç»Ÿ DNS é™åˆ¶æç¤ºï¼š</strong>
        <p style="margin: 5px 0 0 0;">
        ç”±äºæµè§ˆå™¨å®‰å…¨æ¨¡å‹é™åˆ¶ï¼Œæœ¬å·¥å…·æ— æ³•æ‰§è¡Œä¼ ç»Ÿçš„ UDP/TCP DNS è§£æã€‚å½“æ‚¨è¾“å…¥ **IP åœ°å€**æ—¶ï¼Œç³»ç»Ÿä¼š**è‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º `https://IP/dns-query`** æ ¼å¼è¿›è¡Œ HTTPDNS æµ‹è¯•ã€‚
        </p>
        <p style="margin: 5px 0 0 0;">
        **å†…ç½®æœåŠ¡å™¨åˆ—è¡¨å·²æ›´æ–°ï¼š** åŒ…å« Google, Cloudflare, AliDNS, AdGuard, OpenDNS ä»¥åŠ **å¾·å›½å’Œç‘å£«** çš„æ³¨é‡éšç§çš„æ¬§æ´²èŠ‚ç‚¹ï¼Œè¦†ç›–å…¨çƒä¸»è¦åŒºåŸŸã€‚
        </p>
    </div>

    <div class="card">
        <h2>æŸ¥è¯¢ç»“æœ</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th style="width: 45%">æœåŠ¡å™¨åœ°å€</th>
                    <th style="width: 15%">çŠ¶æ€</th>
                    <th style="width: 40%">è§£æç»“æœ / è°ƒè¯•ä¿¡æ¯</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <tr><td colspan="3" style="text-align:center; color:#94a3b8; padding: 20px;">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»å¼€å§‹æŸ¥è¯¢</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨ (è¦†ç›–å…¨çƒï¼Œæ–°å¢å¾·å›½å’Œç‘å£«çš„æ¬§æ´²èŠ‚ç‚¹)
    const DEFAULT_SERVERS = [
        'https://dns.google/resolve',        // Google (å…¨çƒ)
        'https://cloudflare-dns.com/dns-query', // Cloudflare (å…¨çƒ)
        'https://dns.alidns.com/resolve',    // é˜¿é‡Œå·´å·´ (å›½å†…/äºšæ´²)
        'https://dns.adguard-dns.com/dns-query', // AdGuard (å…¨çƒ/ä¸“ä¸šè¿‡æ»¤)
        'https://doh.opendns.com/dns-query',     // OpenDNS/Cisco (æ¬§æ´²/å…¨çƒ)
        'https://public.dns.iij.jp/dns-query',    // IIJ Public DNS (æ—¥æœ¬/äºšæ´²)
        'https://doh.ffmuc.net/dns-query',       // Freifunk/Digitalcourage (å¾·å›½)
        'https://dns.digitale-gesellschaft.ch/dns-query' // Digital Society (ç‘å£«)
    ];

    // IPv4 æ­£åˆ™è¡¨è¾¾å¼ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºä¼ ç»Ÿ IP è¾“å…¥ï¼‰
    const IPV4_REGEX = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
    
    // --- UI åŠ¨æ€æ˜¾ç¤ºé€»è¾‘ ---
    window.onload = function() {
        const domainInput = document.getElementById('domainInput');
        
        // ç›‘å¬ç„¦ç‚¹å’Œè¾“å…¥äº‹ä»¶
        domainInput.addEventListener('focus', showCustomServer);
        domainInput.addEventListener('input', showCustomServer);
    }

    function showCustomServer() {
        const wrapper = document.getElementById('customServerWrapper');
        if (wrapper.style.display === 'none') {
            wrapper.style.display = 'block';
            setTimeout(() => {
                 wrapper.style.opacity = 1; // å»¶è¿Ÿåå¹³æ»‘æ˜¾ç¤º
            }, 10);
            
            // é¦–æ¬¡æ˜¾ç¤ºåç§»é™¤ç›‘å¬å™¨ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤è§¦å‘
            const domainInput = document.getElementById('domainInput');
            domainInput.removeEventListener('focus', showCustomServer);
            domainInput.removeEventListener('input', showCustomServer);
        }
    }
    // -------------------------

    /**
     * æ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œæ™ºèƒ½ç”Ÿæˆè¦æŸ¥è¯¢çš„æœåŠ¡å™¨åˆ—è¡¨
     * @returns {string[]} åŒ…å«æ‰€æœ‰è¦æŸ¥è¯¢çš„ URL åˆ—è¡¨
     */
    function prepareServers() {
        const customServerInput = document.getElementById('customServerInput').value.trim();
        let serversToQuery = [...DEFAULT_SERVERS];
        let customServerUrl = '';

        if (customServerInput) {
            if (IPV4_REGEX.test(customServerInput)) {
                // ä¼ ç»Ÿ DNS IP è¾“å…¥ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º HTTPDNS (https + /dns-query)
                customServerUrl = `https://${customServerInput}/dns-query`;
                console.warn(`[DNS IP è½¬æ¢]: IPåœ°å€ ${customServerInput} å·²è½¬æ¢ä¸º DoH URL: ${customServerUrl}`);
            } else if (!customServerInput.startsWith('http')) {
                // åŸŸåè¾“å…¥ä½†ç¼ºå°‘åè®®å¤´ï¼Œå‡è®¾ä¸º HTTPS
                customServerUrl = `https://${customServerInput}`;
            } else {
                // å®Œæ•´çš„ HTTP/HTTPS URL
                customServerUrl = customServerInput;
            }
            serversToQuery.push(customServerUrl);
        }

        // ç§»é™¤é‡å¤é¡¹å¹¶ç¡®ä¿éç©º
        serversToQuery = Array.from(new Set(serversToQuery)).filter(s => s.length > 0);
        
        return serversToQuery;
    }

    async function startQuery() {
        const domain = document.getElementById('domainInput').value.trim();
        if (!domain) return alert('è¯·è¾“å…¥åŸŸå');

        const serversToQuery = prepareServers();

        const btn = document.getElementById('queryBtn');
        const tbody = document.getElementById('resultBody');
        
        btn.disabled = true;
        btn.innerHTML = 'æŸ¥è¯¢ä¸­...';
        tbody.innerHTML = '';

        serversToQuery.forEach((server, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            let displayUrl = server;
            
            // ä¼˜åŒ–æ˜¾ç¤ºï¼šå¦‚æœæ˜¯è‡ªåŠ¨è½¬æ¢çš„ IP åœ°å€ï¼Œè¿›è¡Œæç¤º
            if (server.includes('/dns-query') && IPV4_REGEX.test(server.replace('https://', '').replace('/dns-query', ''))) {
                displayUrl = `<span style="font-weight: bold; color: #f97316;">(è‡ªå®šä¹‰ IP è½¬æ¢)</span> ${server}`;
            }

            tr.innerHTML = `
                <td style="word-break:break-all;">
                    <div>${displayUrl}</div>
                    <div class="meta-info">ç­‰å¾…è¯·æ±‚...</div>
                </td>
                <td><span class="status-badge st-wait">Pending</span></td>
                <td>-</td>
            `;
            tbody.appendChild(tr);
        });

        const promises = serversToQuery.map((server, index) => doFetch(server, domain, index));
        await Promise.all(promises);

        btn.disabled = false;
        btn.innerHTML = 'ğŸš€ å¼€å§‹æŸ¥è¯¢';
    }

    async function doFetch(serverUrl, domain, index) {
        const row = document.getElementById(`row-${index}`);
        const statusCell = row.cells[1];
        const resultCell = row.cells[2];
        const metaDiv = row.cells[0].querySelector('.meta-info');
        
        const startTime = performance.now();

        try {
            const urlObj = new URL(serverUrl);
            
            // æ ‡å‡†å‚æ•°
            urlObj.searchParams.set('name', domain);
            urlObj.searchParams.set('type', 'A');

            const headers = { 'Accept': 'application/dns-json' };

            const res = await fetch(urlObj.toString(), { method: 'GET', headers });

            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

            const data = await res.json();
            const endTime = performance.now();
            const duration = Math.round(endTime - startTime);

            metaDiv.textContent = `è€—æ—¶: ${duration}ms`;

            if (data.Answer) {
                statusCell.innerHTML = `<span class="status-badge st-ok">Success</span>`;
                const ips = data.Answer
                    .filter(r => r.type === 1) // A è®°å½•
                    .map(r => r.data)
                    .join(', ');
                resultCell.innerHTML = `<div class="ip-list">${ips || 'æ— Aè®°å½•'}</div>`;
                if(!ips && data.Answer.length > 0) {
                    resultCell.innerHTML += `<div class="meta-info">éAè®°å½•æ•°æ®: ${JSON.stringify(data.Answer.map(r => ({type: r.type, data: r.data})))}</div>`;
                }
            } else {
                statusCell.innerHTML = `<span class="status-badge st-ok">æ— ç»“æœ</span>`;
                resultCell.textContent = `Status: ${data.Status} (æ—  Answer å­—æ®µ)`;
            }

        } catch (err) {
            const duration = Math.round(performance.now() - startTime);
            metaDiv.textContent = `è€—æ—¶: ${duration}ms`;
            statusCell.innerHTML = `<span class="status-badge st-err">Error</span>`;
            
            let errorMsg = err.message;
            if (errorMsg.includes('Failed to fetch')) {
                errorMsg = 'è¿æ¥è¢«é˜»æ–­ (CORSã€ç½‘ç»œæˆ–è¯ä¹¦é”™è¯¯)';
            }
            resultCell.innerHTML = `<span style="color:#b91c1c;">${errorMsg}</span>`;
        }
    }
</script>

</body>
</html>
