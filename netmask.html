<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­ç½‘æ©ç è®¡ç®—å™¨ - æ™ºèƒ½è¶…ç½‘è¯†åˆ«ç‰ˆ</title>
    <meta name="description" content="çº¯å‰ç«¯åœ¨çº¿å­ç½‘æ©ç è®¡ç®—å™¨ã€‚æ”¯æŒ IPv4 å’Œ IPv6ï¼Œæ”¯æŒ CIDR è®¡ç®—ä»¥åŠä»»æ„ IP èŒƒå›´çš„è¶…ç½‘/å­ç½‘åæ¨ã€‚">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* --- å¯¼èˆªæ  --- */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            height: 64px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-links { display: flex; gap: 20px; }
        .nav-link {
            text-decoration: none;
            color: var(--text-sub);
            font-weight: 500;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .nav-link:hover { color: var(--primary); }
        .nav-link.current { color: var(--primary); font-weight: 600; }
        @media (max-width: 768px) { .nav-links { display: none; } }

        /* --- ä¸»å®¹å™¨ --- */
        .main-container {
            max-width: 800px;
            margin: 40px auto 60px;
            padding: 0 20px;
        }

        .header-section { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }
        .subtitle {
            font-size: 1.05rem;
            color: var(--text-sub);
            font-weight: 400;
        }

        /* --- æ ¸å¿ƒå¡ç‰‡ --- */
        .tool-card-main {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            border: 1px solid var(--border);
            position: relative;
        }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-toggle {
            display: flex;
            background: var(--bg);
            border-radius: var(--radius);
            padding: 4px;
            margin-bottom: 25px;
        }
        .mode-button {
            flex: 1;
            padding: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--text-sub);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .mode-button.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 8px;
        }
        
        .ip-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-main);
            box-sizing: border-box;
            transition: all 0.2s;
            font-family: monospace;
            outline: none;
        }
        
        .ip-input:focus {
             border-color: var(--primary); 
             box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        
        /* æŒ‰é’® */
        .btn-action {
            width: 100%;
            padding: 14px;
            font-size: 1.05rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }
        .btn-action:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-action:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ç»“æœæ˜¾ç¤ºåŒº */
        .result-panel {
            margin-top: 25px;
            display: none;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.95rem;
        }
        .result-item:last-child { border-bottom: none; }

        .result-label { color: var(--text-sub); font-weight: 500; }
        .result-value { color: var(--text-main); font-family: monospace; font-weight: 600; text-align: right; }
        
        /* æç¤ºä¿¡æ¯ */
        .result-note {
            background: #eff6ff;
            color: #1e40af;
            font-size: 0.85rem;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid var(--primary);
        }

        .result-error-box {
            background: #fee2e2; color: #991b1b;
            padding: 12px; border-radius: 8px; text-align: center;
            font-size: 0.9rem; font-weight: 500;
        }

        footer { text-align: center; color: var(--text-sub); font-size: 0.8rem; margin-top: 60px; padding-bottom: 30px; border-top: 1px solid var(--border); padding-top: 30px; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <a href="#" class="nav-logo">ğŸ”’ å®‰å…¨å·¥å…·ç®±</a>
        <div class="nav-links">
            <a href="#" class="nav-link">é™æ—¶å¯†ä¿¡</a>
            <a href="watermark.html" class="nav-link">åœ¨çº¿æ°´å°</a>
            <a href="dns.html" class="nav-link">DNS æŸ¥è¯¢</a>
            <a href="#" class="nav-link current">å­ç½‘è®¡ç®—</a>
        </div>
    </div>
</nav>

<div class="main-container">
    
    <div class="header-section">
        <h1>å­ç½‘æ©ç è®¡ç®—å™¨</h1>
        <div class="subtitle">IPv4 / IPv6 æ™ºèƒ½è®¡ç®— Â· è‡ªåŠ¨è¯†åˆ«è¶…ç½‘ä¸å­ç½‘</div>
    </div>

    <div class="tool-card-main">
        
        <div class="mode-toggle">
            <button class="mode-button active" data-mode="cidr">CIDR/æ©ç ä½è®¡ç®—</button>
            <button class="mode-button" data-mode="range">IP èŒƒå›´åæ¨</button>
        </div>

        <div id="modeCidr" class="mode-content">
            <div class="input-group">
                <label for="cidrCombinedInput">è¾“å…¥ IP åœ°å€å’Œæ©ç ä½ (å¦‚ 192.168.1.1/24 æˆ– 2001:db8::1/64)</label>
                <input type="text" id="cidrCombinedInput" placeholder="192.168.1.1/24" class="ip-input">
            </div>
            <button id="calcCidrBtn" class="btn-action">ğŸ” è®¡ç®—å­ç½‘ä¿¡æ¯</button>
        </div>

        <div id="modeRange" class="mode-content" style="display: none;">
            <div class="input-group">
                <label for="firstIpInput">èµ·å§‹ IP åœ°å€</label>
                <input type="text" id="firstIpInput" placeholder="ä¾‹å¦‚: 192.168.4.1" class="ip-input">
            </div>
            <div class="input-group">
                <label for="lastIpInput">ç»“æŸ IP åœ°å€</label>
                <input type="text" id="lastIpInput" placeholder="ä¾‹å¦‚: 192.168.9.254" class="ip-input">
            </div>
            <button id="calcRangeBtn" class="btn-action">â†©ï¸ åæ¨æœ€å°åŒ…å›´å­ç½‘</button>
        </div>

        <div id="resultPanel" class="result-panel">
            <div id="resultError" class="result-error-box" style="display: none;"></div>
            <div id="resultNote" class="result-note" style="display: none;"></div>
            <div id="resultOutput"></div>
        </div>
    </div>

    <footer>
        ç½‘ç»œå·¥å…· | çº¯å‰ç«¯è®¡ç®— | æ‚¨çš„æ•°æ®ä¸ä¼šä¸Šä¼ 
    </footer>
</div>

<script>
    // --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

    function showError(message, resultError, resultPanel, resultOutput, resultNote) {
        resultError.textContent = message;
        resultError.style.display = 'block';
        resultPanel.style.display = 'block';
        if(resultOutput) resultOutput.innerHTML = '';
        if(resultNote) resultNote.style.display = 'none';
    }
    
    // å®¹é”™: ä¸­æ–‡ç¬¦å·è½¬è‹±æ–‡
    function cleanInput(input) {
        if (typeof input !== 'string') return input;
        return input.replace(/ã€‚/g, '.').replace(/ï¼š/g, ':').trim();
    }

    // IP ç‰ˆæœ¬æ£€æµ‹
    function getIPVersion(input) {
        const ipStr = input.split('/')[0].trim();
        if (ipStr.includes(':')) return isValidIPv6(ipStr) ? 'IPv6' : 'Invalid';
        if (ipStr.includes('.')) return isValidIp(ipStr) ? 'IPv4' : 'Invalid';
        return 'Invalid';
    }

    // --- IPv4 é€»è¾‘ ---
    function isValidIp(ip) {
        if (!ip) return false;
        const regex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;
        if (!regex.test(ip)) return false;
        return ip.split('.').every(octet => parseInt(octet) >= 0 && parseInt(octet) <= 255);
    }

    function ipToInt(ip) {
        return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0) >>> 0;
    }

    function intToIp(int) {
        return [(int >>> 24) & 0xFF, (int >>> 16) & 0xFF, (int >>> 8) & 0xFF, int & 0xFF].join('.');
    }

    function getV4MaskInt(cidr) {
        return cidr === 0 ? 0 : (0xFFFFFFFF << (32 - cidr)) >>> 0;
    }

    function getV4MaskIp(cidr) {
        return intToIp(getV4MaskInt(cidr));
    }

    // --- IPv6 é€»è¾‘ ---
    function isValidIPv6(ip) {
        if (!ip) return false;
        const parts = ip.split(':');
        let emptyCount = 0;
        for (const part of parts) {
            if (part === '') emptyCount++;
            else if (!/^[0-9a-fA-F]{1,4}$/.test(part)) return false;
        }
        const nonNullParts = parts.filter(p => p !== '').length;
        return ip.includes('::') ? (nonNullParts <= 7 && emptyCount <= 2) : (parts.length === 8);
    }

    function normalizeIPv6(ip) {
        if (!ip.includes('::')) return ip.split(':').map(p => p.padStart(4, '0')).join('').toLowerCase();
        const [start, end] = ip.split('::');
        const startParts = start.split(':').filter(p => p);
        const endParts = end.split(':').filter(p => p);
        const padding = new Array(8 - startParts.length - endParts.length).fill('0000').join('');
        const startHex = startParts.map(p => p.padStart(4, '0')).join('');
        const endHex = endParts.map(p => p.padStart(4, '0')).join('');
        return (startHex + padding + endHex).toLowerCase();
    }

    function ipV6ToBigInt(hex32String) {
        return BigInt('0x' + hex32String);
    }

    function bigIntToCompressedIPv6(bigInt) {
        let hex = bigInt.toString(16).padStart(32, '0');
        let parts = [];
        for (let i = 0; i < 32; i += 4) parts.push(hex.substring(i, i + 4));
        parts = parts.map(p => p.replace(/^0+/, '') || '0');
        
        let maxZeros = 0, maxIndex = -1, currentZeros = 0, startIndex = -1;
        for (let i = 0; i < parts.length; i++) {
            if (parts[i] === '0') {
                if (currentZeros === 0) startIndex = i;
                currentZeros++;
            } else {
                if (currentZeros > maxZeros) { maxZeros = currentZeros; maxIndex = startIndex; }
                currentZeros = 0;
            }
        }
        if (currentZeros > maxZeros) { maxZeros = currentZeros; maxIndex = startIndex; }
        if (maxZeros >= 2) parts.splice(maxIndex, maxZeros, '');
        
        let res = parts.join(':').toLowerCase();
        if (res.startsWith(':')) res = ':' + res;
        if (res.endsWith(':') && !res.endsWith('::')) res = res + ':';
        return res.replace(/:::/g, '::');
    }

    function getV6MaskBigInt(prefix) {
        if (prefix === 0) return 0n;
        const hostBits = 128n - BigInt(prefix);
        return ((1n << 128n) - 1n) ^ ((1n << hostBits) - 1n);
    }

    // =================================================================
    // åŠŸèƒ½ 1: CIDR è®¡ç®—
    // =================================================================
    function calculateCidrDetails() {
        const combinedInput = cleanInput(document.getElementById('cidrCombinedInput').value);
        const resultPanel = document.getElementById('resultPanel');
        const resultError = document.getElementById('resultError');
        const resultOutput = document.getElementById('resultOutput');
        const resultNote = document.getElementById('resultNote');
        
        resultError.style.display = 'none';
        resultNote.style.display = 'none';
        resultOutput.innerHTML = '';
        resultPanel.style.display = 'none';

        const parts = combinedInput.split('/');
        let ipStr = parts[0].trim();
        let prefix = parts.length === 2 ? parseInt(parts[1].trim()) : null;

        const version = getIPVersion(ipStr);
        if (version === 'Invalid') {
             showError("æ— æ³•è¯†åˆ«çš„ IP åœ°å€æ ¼å¼ã€‚", resultError, resultPanel, resultOutput);
             return;
        }

        // è®¾ç½®é»˜è®¤æ©ç 
        if (prefix === null) prefix = version === 'IPv4' ? 32 : 128;

        if (version === 'IPv4' && (isNaN(prefix) || prefix < 0 || prefix > 32)) {
            showError("IPv4 æ©ç ä½å¿…é¡»åœ¨ 0 åˆ° 32 ä¹‹é—´ã€‚", resultError, resultPanel, resultOutput);
            return;
        }
        if (version === 'IPv6' && (isNaN(prefix) || prefix < 0 || prefix > 128)) {
            showError("IPv6 å‰ç¼€é•¿åº¦å¿…é¡»åœ¨ 0 åˆ° 128 ä¹‹é—´ã€‚", resultError, resultPanel, resultOutput);
            return;
        }

        try {
            if (version === 'IPv4') {
                const ipInt = ipToInt(ipStr);
                const maskInt = getV4MaskInt(prefix);
                const networkInt = (ipInt & maskInt) >>> 0;
                const hostBits = 32 - prefix;
                const totalAddresses = 1 << hostBits;
                const broadcastInt = (networkInt | (totalAddresses - 1)) >>> 0;
                
                const availableHosts = totalAddresses >= 4 ? totalAddresses - 2 : (prefix === 31 ? 2 : (prefix === 32 ? 1 : 0));
                
                let firstIp = 'N/A', lastIp = 'N/A';
                if (prefix === 32) { firstIp = lastIp = intToIp(networkInt); }
                else if (prefix === 31) { firstIp = intToIp(networkInt); lastIp = intToIp(broadcastInt); }
                else { firstIp = intToIp(networkInt + 1); lastIp = intToIp(broadcastInt - 1); }

                renderResults(resultOutput, [
                    { l: "IP ç‰ˆæœ¬", v: "IPv4" },
                    { l: "ç½‘ç»œåœ°å€", v: intToIp(networkInt) },
                    { l: "å­ç½‘æ©ç ", v: getV4MaskIp(prefix) },
                    { l: "å¯ç”¨ IP æ•°é‡", v: availableHosts.toLocaleString() },
                    { l: "é¦–ä¸ªå¯ç”¨ IP", v: firstIp },
                    { l: "æœ€åå¯ç”¨ IP", v: lastIp },
                    { l: "å¹¿æ’­åœ°å€", v: intToIp(broadcastInt) }
                ]);

            } else { // IPv6
                const ipBigInt = ipV6ToBigInt(normalizeIPv6(ipStr));
                const maskBigInt = getV6MaskBigInt(prefix);
                const networkBigInt = ipBigInt & maskBigInt;
                const hostBits = 128n - BigInt(prefix);
                const lastBigInt = networkBigInt | ((1n << hostBits) - 1n);
                
                // IPv6 çº¦å®šæ˜¾ç¤ºé€»è¾‘
                let firstIp, lastIp;
                if (prefix === 128) { firstIp = lastIp = bigIntToCompressedIPv6(networkBigInt); }
                else if (prefix === 127) { firstIp = bigIntToCompressedIPv6(networkBigInt); lastIp = bigIntToCompressedIPv6(lastBigInt); }
                else {
                    firstIp = bigIntToCompressedIPv6(networkBigInt + 1n); // é€šå¸¸ Router Anycast åçš„ç¬¬ä¸€ä¸ª
                    lastIp = bigIntToCompressedIPv6(lastBigInt - 1n);
                }

                renderResults(resultOutput, [
                    { l: "IP ç‰ˆæœ¬", v: "IPv6" },
                    { l: "ç½‘ç»œå‰ç¼€", v: `${bigIntToCompressedIPv6(networkBigInt)}/${prefix}` },
                    { l: "æ€»åœ°å€æ•°", v: `2^${hostBits}` },
                    { l: "é¦–ä¸ªåœ°å€", v: firstIp },
                    { l: "æœ€åä¸€ä¸ªåœ°å€", v: lastIp },
                    { l: "èŒƒå›´ç»“æŸ", v: bigIntToCompressedIPv6(lastBigInt) }
                ]);
            }
            resultPanel.style.display = 'block';
        } catch (e) { showError("è®¡ç®—é”™è¯¯", resultError, resultPanel); }
    }

    // =================================================================
    // åŠŸèƒ½ 2: èŒƒå›´åæ¨ (æ™ºèƒ½è¶…ç½‘è®¡ç®—)
    // =================================================================
    function calculateRangeDetails() {
        const firstIpStr = cleanInput(document.getElementById('firstIpInput').value);
        const lastIpStr = cleanInput(document.getElementById('lastIpInput').value);
        
        const resultPanel = document.getElementById('resultPanel');
        const resultError = document.getElementById('resultError');
        const resultOutput = document.getElementById('resultOutput');
        const resultNote = document.getElementById('resultNote');

        resultError.style.display = 'none';
        resultOutput.innerHTML = '';
        resultNote.style.display = 'none';
        resultPanel.style.display = 'none';

        const ver = getIPVersion(firstIpStr);
        if (ver === 'Invalid' || getIPVersion(lastIpStr) !== ver) {
            showError("è¯·è¾“å…¥æœ‰æ•ˆçš„ã€ç‰ˆæœ¬ä¸€è‡´çš„èµ·å§‹å’Œç»“æŸ IPã€‚", resultError, resultPanel);
            return;
        }

        try {
            if (ver === 'IPv4') {
                const start = ipToInt(firstIpStr);
                const end = ipToInt(lastIpStr);
                if (start >= end) { showError("èµ·å§‹ IP å¿…é¡»å°äºç»“æŸ IPã€‚", resultError, resultPanel); return; }

                // --- ç®—æ³•æ›´æ–°ï¼šå¯»æ‰¾æœ€å°åŒ…å›´å­ç½‘ ---
                // 1. è®¡ç®—ä¸¤ä¸ªIPçš„å¼‚æˆ–å€¼ï¼Œæ‰¾åˆ°æœ€é«˜ä¸åŒä½
                const xor = start ^ end;
                // 2. ç¡®å®šéœ€è¦å¤šå°‘ä¸ªä¸»æœºä½æ‰èƒ½è¦†ç›–è¿™ä¸ªå·®å¼‚
                // Math.clz32 è¿”å›å‰å¯¼0çš„ä¸ªæ•°ã€‚32 - clz32(xor) å°±æ˜¯æœ€é«˜æœ‰æ•ˆä½çš„ä½ç½®(ä»1å¼€å§‹è®¡æ•°)
                // ä¾‹å¦‚ï¼šå¦‚æœxoræ˜¯ 0000...0101 (5)ï¼Œclz32æ˜¯29ï¼Œæœ‰æ•ˆä½æ˜¯3ã€‚éœ€è¦3ä½ä¸»æœºä½(æ©ç /29)æ‰èƒ½è¦†ç›–å·®å¼‚ã€‚
                // ä½†ä»…ä»…è¦†ç›–å·®å¼‚ä¸å¤Ÿï¼Œè¿˜éœ€è¦ç”±äºå¯¹é½é—®é¢˜å¯¼è‡´çš„é¢å¤–ä½ã€‚
                
                // æ›´ç®€å•çš„é€»è¾‘ï¼šä» /32 å¼€å§‹é€’å‡ï¼Œç›´åˆ° (start & mask) == (end & mask)
                let cidr = 32;
                while (cidr > 0) {
                    const mask = getV4MaskInt(cidr);
                    if ((start & mask) === (end & mask)) break;
                    cidr--;
                }
                
                const maskInt = getV4MaskInt(cidr);
                const networkInt = (start & maskInt) >>> 0;
                const hostBits = 32 - cidr;
                const broadcastInt = networkInt | ((1 << hostBits) - 1);
                
                // åˆ¤æ–­æ˜¯å¦æ˜¯â€œå®Œç¾åŒ¹é…â€
                const isExactMatch = (networkInt + 1 === start) && (broadcastInt - 1 === end);
                const isSubSet = !isExactMatch;

                if (isSubSet) {
                    resultNote.textContent = `ğŸ’¡ æ³¨æ„ï¼šæ‚¨è¾“å…¥çš„èŒƒå›´ (${firstIpStr} - ${lastIpStr}) ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ CIDR å­ç½‘è¾¹ç•Œã€‚ä¸‹æ–¹ç»“æœæ˜¯èƒ½åŒ…å«æ­¤èŒƒå›´çš„ã€æœ€å°å…¬å…±å­ç½‘ã€‘ã€‚`;
                    resultNote.style.display = 'block';
                }

                renderResults(resultOutput, [
                    { l: "è®¡ç®—ç»“æœ (CIDR)", v: `/${cidr}` },
                    { l: "åŒ…å«è¯¥èŒƒå›´çš„ç½‘ç»œ", v: `${intToIp(networkInt)}/${cidr}` },
                    { l: "å­ç½‘æ©ç ", v: getV4MaskIp(cidr) },
                    { l: "ç½‘ç»œåœ°å€", v: intToIp(networkInt) },
                    { l: "å¹¿æ’­åœ°å€", v: intToIp(broadcastInt) },
                    { l: "æ ‡å‡†å¯ç”¨èŒƒå›´", v: `${intToIp(networkInt+1)} - ${intToIp(broadcastInt-1)}` }
                ]);

            } else { // IPv6
                const start = ipV6ToBigInt(normalizeIPv6(firstIpStr));
                const end = ipV6ToBigInt(normalizeIPv6(lastIpStr));
                if (start >= end) { showError("èµ·å§‹ IP å¿…é¡»å°äºç»“æŸ IPã€‚", resultError, resultPanel); return; }

                let prefix = 128;
                while (prefix > 0) {
                    const mask = getV6MaskBigInt(prefix);
                    if ((start & mask) === (end & mask)) break;
                    prefix--;
                }
                
                const mask = getV6MaskBigInt(prefix);
                const network = start & mask;
                const hostBits = 128n - BigInt(prefix);
                const lastAddr = network | ((1n << hostBits) - 1n);

                // æ£€æŸ¥æ˜¯å¦å®Œç¾åŒ¹é… (ç®€å•å¯¹æ¯”é¦–å°¾)
                // IPv6 æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€å•æç¤ºå¦‚æœæ˜¯å­é›†
                if (network !== start || lastAddr !== end) {
                    resultNote.textContent = `ğŸ’¡ æ³¨æ„ï¼šæ‚¨è¾“å…¥çš„èŒƒå›´æ˜¯ä¸‹æ–¹è®¡ç®—å‡ºçš„ã€æœ€å°å…¬å…±å‰ç¼€ã€‘çš„å­é›†ã€‚`;
                    resultNote.style.display = 'block';
                }

                renderResults(resultOutput, [
                    { l: "è®¡ç®—ç»“æœ (Prefix)", v: `/${prefix}` },
                    { l: "ç½‘ç»œå‰ç¼€", v: `${bigIntToCompressedIPv6(network)}/${prefix}` },
                    { l: "å®Œæ•´èŒƒå›´èµ·å§‹", v: bigIntToCompressedIPv6(network) },
                    { l: "å®Œæ•´èŒƒå›´ç»“æŸ", v: bigIntToCompressedIPv6(lastAddr) }
                ]);
            }
            resultPanel.style.display = 'block';
        } catch(e) { showError("è®¡ç®—é”™è¯¯: " + e.message, resultError, resultPanel); }
    }

    function renderResults(container, items) {
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `<span class="result-label">${item.l}</span><span class="result-value">${item.v}</span>`;
            container.appendChild(div);
        });
    }

    // --- åˆå§‹åŒ– ---
    function switchMode(mode) {
        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.mode-button[data-mode="${mode}"]`).classList.add('active');
        document.getElementById('modeCidr').style.display = mode === 'cidr' ? 'block' : 'none';
        document.getElementById('modeRange').style.display = mode === 'range' ? 'block' : 'none';
        document.getElementById('resultPanel').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.mode-button').forEach(btn => 
            btn.addEventListener('click', (e) => switchMode(e.target.getAttribute('data-mode'))));
        
        document.getElementById('calcCidrBtn').addEventListener('click', calculateCidrDetails);
        document.getElementById('calcRangeBtn').addEventListener('click', calculateRangeDetails);
        
        // å›è½¦æ”¯æŒ
        ['cidrCombinedInput', 'firstIpInput', 'lastIpInput'].forEach(id => {
            document.getElementById(id).addEventListener('keydown', e => {
                if (e.key === 'Enter') id === 'cidrCombinedInput' ? calculateCidrDetails() : calculateRangeDetails();
            });
        });
        
        switchMode('cidr');
    });
</script>
</body>
</html>
