<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPDNS å…¨èƒ½éªŒè¯å·¥å…·</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: #334155;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #1e293b; text-align: center; margin-bottom: 30px; }
        h2 { font-size: 1.1rem; margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* æŸ¥è¯¢æ  */
        .query-box { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 6px;
            font-size: 14px; font-family: monospace;
        }
        input[type="text"]:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-danger { background: #fee2e2; color: var(--danger); padding: 6px 12px; font-size: 0.9em; }
        .btn-danger:hover { background: #fecaca; }

        /* é…ç½®åŒº */
        .preset-bar { display: flex; gap: 10px; margin-bottom: 15px; background: #f1f5f9; padding: 10px; border-radius: 8px; align-items: center; }
        .preset-select { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #cbd5e1; }
        
        .server-list { display: flex; flex-direction: column; gap: 8px; }
        .server-item { display: flex; gap: 8px; align-items: center; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 0.9em; font-weight: 600; }
        td { padding: 12px; border-top: 1px solid var(--border); vertical-align: middle; }
        
        .status-badge {
            display: inline-flex; align-items: center; padding: 4px 8px;
            border-radius: 99px; font-size: 12px; font-weight: 600;
        }
        .st-wait { background: #f1f5f9; color: #64748b; }
        .st-ok { background: #dcfce7; color: #15803d; }
        .st-err { background: #fee2e2; color: #b91c1c; }
        
        .ip-list { font-family: monospace; font-weight: bold; color: #0f172a; }
        .meta-info { font-size: 0.85em; color: #94a3b8; margin-top: 4px; }

        .tips { font-size: 0.9em; color: #64748b; background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f97316; }
    </style>
</head>
<body>

<div class="container">
    <h1>HTTPDNS å…¨èƒ½éªŒè¯å·¥å…·</h1>

    <div class="card">
        <div class="query-box">
            <input type="text" id="domainInput" value="www.google.com" placeholder="è¯·è¾“å…¥è¦è§£æçš„åŸŸå">
            <button class="btn btn-primary" id="queryBtn" onclick="startQuery()">ğŸš€ å¼€å§‹æŸ¥è¯¢</button>
        </div>
    </div>

    <div class="card">
        <h2>
            <span>æœåŠ¡å™¨é…ç½®</span>
            <button class="btn" style="font-size:0.8em; color:#64748b; background:none; border:1px solid #e2e8f0;" onclick="resetServers()">â†º é‡ç½®åˆ—è¡¨</button>
        </h2>
        
        <div class="preset-bar">
            <span style="font-weight:bold; font-size:0.9em;">å¿«é€Ÿæ·»åŠ é¢„è®¾ (æ¨èä½¿ç”¨):</span>
            <select id="presetSelect" class="preset-select">
                <option value="https://dns.google/resolve">Google (å…¨çƒ - JSON API)</option>
                <option value="https://cloudflare-dns.com/dns-query">Cloudflare (å…¨çƒ - æ¨è)</option>
                <option value="https://doh.pub/dns-query">è…¾è®¯ DNSPod (å›½å†… - æ¨è)</option>
                <option value="https://dns.alidns.com/resolve">é˜¿é‡Œ AliDNS (å›½å†… - JSON API)</option>
                <option value="https://doh.opendns.com/dns-query">OpenDNS (æ€ç§‘)</option>
            </select>
            <button class="btn btn-primary" style="padding: 8px 16px;" onclick="addPreset()">+ æ·»åŠ </button>
        </div>

        <div id="serverList" class="server-list">
            </div>
    </div>

    <div class="card">
        <h2>æŸ¥è¯¢ç»“æœ</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th style="width: 45%">æœåŠ¡å™¨åœ°å€</th>
                    <th style="width: 15%">çŠ¶æ€</th>
                    <th style="width: 40%">è§£æç»“æœ / è°ƒè¯•ä¿¡æ¯</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <tr><td colspan="3" style="text-align:center; color:#94a3b8; padding: 20px;">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»å¼€å§‹æŸ¥è¯¢</td></tr>
            </tbody>
        </table>
    </div>

    <div class="tips">
        <strong>ğŸ’¡ å¸¸è§é—®é¢˜æ’æŸ¥ï¼š</strong>
        <ul style="margin: 5px 0 0 20px; padding:0;">
            <li>**Network Error?** å¤šæ•°æ˜¯ CORS è·¨åŸŸé™åˆ¶æˆ–ç›®æ ‡æœåŠ¡å™¨ç½‘ç»œä¸ç¨³å®šå¯¼è‡´ã€‚</li>
            <li>**HTTP 400 é”™è¯¯ï¼Ÿ** è¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆä¾‹å¦‚ï¼šGoogle/é˜¿é‡Œå¿…é¡»æ˜¯ `/resolve` ç»“å°¾ï¼‰ã€‚</li>
        </ul>
    </div>
</div>

<script>
    // é»˜è®¤æœåŠ¡å™¨åˆ—è¡¨ (åªä¿ç•™å¤§å‚çš„åŸŸååœ°å€)
    const DEFAULT_SERVERS = [
        'https://dns.google/resolve',       
        'https://cloudflare-dns.com/dns-query', 
        'https://doh.pub/dns-query'     // è…¾è®¯äº‘ DNSPod åŸŸååœ°å€
    ];

    let servers = [...DEFAULT_SERVERS];

    // åˆå§‹åŒ–
    window.onload = () => {
        renderServerList();
    };

    function renderServerList() {
        const container = document.getElementById('serverList');
        container.innerHTML = '';
        servers.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'server-item';
            div.innerHTML = `
                <input type="text" value="${url}" onchange="updateServer(${index}, this.value)">
                <button class="btn btn-danger" onclick="removeServer(${index})">åˆ é™¤</button>
            `;
            container.appendChild(div);
        });
    }

    function addPreset() {
        const select = document.getElementById('presetSelect');
        const url = select.value;
        if (!servers.includes(url)) {
            servers.push(url);
            renderServerList();
        } else {
            alert('è¯¥æœåŠ¡å™¨å·²åœ¨åˆ—è¡¨ä¸­');
        }
    }

    function removeServer(index) {
        servers.splice(index, 1);
        renderServerList();
    }

    function updateServer(index, val) {
        servers[index] = val.trim();
    }

    function resetServers() {
        if(confirm("æ¢å¤é»˜è®¤åˆ—è¡¨ï¼Ÿ")) {
            servers = [...DEFAULT_SERVERS];
            renderServerList();
        }
    }

    async function startQuery() {
        const domain = document.getElementById('domainInput').value.trim();
        if (!domain) return alert('è¯·è¾“å…¥åŸŸå');

        const btn = document.getElementById('queryBtn');
        const tbody = document.getElementById('resultBody');
        
        btn.disabled = true;
        btn.innerHTML = 'æŸ¥è¯¢ä¸­...';
        tbody.innerHTML = '';

        const activeServers = servers.filter(s => s.length > 0);

        activeServers.forEach((server, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td style="word-break:break-all;">
                    <div>${server}</div>
                    <div class="meta-info">ç­‰å¾…è¯·æ±‚...</div>
                </td>
                <td><span class="status-badge st-wait">Pending</span></td>
                <td>-</td>
            `;
            tbody.appendChild(tr);
        });

        const promises = activeServers.map((server, index) => doFetch(server, domain, index));
        await Promise.all(promises);

        btn.disabled = false;
        btn.innerHTML = 'ğŸš€ å¼€å§‹æŸ¥è¯¢';
    }

    async function doFetch(serverUrl, domain, index) {
        const row = document.getElementById(`row-${index}`);
        const statusCell = row.cells[1];
        const resultCell = row.cells[2];
        const metaDiv = row.cells[0].querySelector('.meta-info');
        
        const startTime = performance.now();

        try {
            const urlObj = new URL(serverUrl);
            
            urlObj.searchParams.set('name', domain);
            urlObj.searchParams.set('type', 'A');

            const headers = { 'Accept': 'application/dns-json' };

            const res = await fetch(urlObj.toString(), { method: 'GET', headers });

            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

            const data = await res.json();
            const endTime = performance.now();
            const duration = Math.round(endTime - startTime);

            metaDiv.textContent = `è€—æ—¶: ${duration}ms`;

            if (data.Answer) {
                statusCell.innerHTML = `<span class="status-badge st-ok">Success</span>`;
                const ips = data.Answer
                    .filter(r => r.type === 1) // A è®°å½•
                    .map(r => r.data)
                    .join(', ');
                resultCell.innerHTML = `<div class="ip-list">${ips || 'æ— Aè®°å½•'}</div>`;
                if(!ips && data.Answer.length > 0) {
                    resultCell.innerHTML += `<div class="meta-info">éAè®°å½•æ•°æ®: ${JSON.stringify(data.Answer.map(r => ({type: r.type, data: r.data})))}</div>`;
                }
            } else {
                statusCell.innerHTML = `<span class="status-badge st-ok">æ— ç»“æœ</span>`;
                resultCell.textContent = `Status: ${data.Status} (æ—  Answer å­—æ®µ)`;
            }

        } catch (err) {
            const duration = Math.round(performance.now() - startTime);
            metaDiv.textContent = `è€—æ—¶: ${duration}ms`;
            statusCell.innerHTML = `<span class="status-badge st-err">Error</span>`;
            
            let errorMsg = err.message;
            if (errorMsg.includes('Failed to fetch')) {
                errorMsg = 'è¿æ¥è¢«é˜»æ–­ (CORS æˆ– ç½‘ç»œé”™è¯¯)';
            }
            resultCell.innerHTML = `<span style="color:#b91c1c;">${errorMsg}</span>`;
        }
    }
</script>

</body>
</html>
