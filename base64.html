<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 ç¼–/è§£ç å·¥å…· (ç®€çº¦ç‰ˆ)</title>
    <style>
        /* æ²¿ç”¨å¹¶ä¼˜åŒ–è‡ªä¸Šä¸€ä¸ªå·¥å…·çš„ç®€çº¦é£æ ¼ */
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: #334155;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #1e293b; text-align: center; margin-bottom: 20px; }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* æ§ä»¶åŒºåŸŸå¸ƒå±€ */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .input-group { width: 100%; }
        
        .input-group label { display: block; font-size: 0.9em; font-weight: 600; margin-bottom: 5px; color: #475569; }

        textarea {
            width: 100%; min-height: 150px; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 6px;
            font-size: 14px; font-family: monospace; box-sizing: border-box;
            resize: vertical;
        }
        /* æ·»åŠ ä¸€ä¸ª visual hint */
        #outputText { cursor: copy; } 
        
        textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }

        select {
            padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--card); font-size: 14px; cursor: pointer;
            height: 40px;
            min-width: 120px;
        }

        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
            height: 40px; 
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .error-message { color: var(--danger); font-size: 0.9em; margin-top: 5px; }
        
        /* æç¤ºä¿¡æ¯æ ·å¼ */
        .tips { 
            font-size: 0.9em; 
            color: #64748b; 
            background: #eff6ff; 
            padding: 10px 15px; 
            border-radius: 8px; 
            border-left: 4px solid var(--primary); 
            margin-bottom: 15px;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>Base64 ç¼–/è§£ç å·¥å…·</h1>

    <div class="card">
        <div class="input-group">
            <label for="inputText">è¾“å…¥å†…å®¹ (æ˜æ–‡æˆ– Base64 ç¼–ç )</label>
            <textarea id="inputText" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬..." autofocus></textarea>
        </div>
    </div>
    
    <div class="controls">
        <div class="input-group" style="flex-grow: 0;">
            <label for="encodingSelect">å­—ç¬¦ç¼–ç </label>
            <select id="encodingSelect">
                <option value="utf-8">UTF-8 (é»˜è®¤)</option>
                <option value="ascii">ASCII</option>
                <option value="iso-8859-1">Latin-1 (ISO-8859-1)</option>
                <option value="gbk">GBK (éœ€æµè§ˆå™¨æ”¯æŒ)</option>
            </select>
        </div>

        <div style="flex-grow: 1;"></div>
        
        <button class="btn btn-primary" id="actionBtn" onclick="b64Action()">âš¡ è‡ªåŠ¨å¤„ç† / åˆ‡æ¢</button>
    </div>

    <div class="card">
        <div class="tips">
            ğŸ’¡ **æç¤ºï¼š** åŒå‡»ä¸‹æ–¹çš„æ–‡æœ¬æ¡†å†…å®¹ï¼Œå¯ä»¥å¿«é€Ÿå¤åˆ¶ç»“æœåˆ°å‰ªåˆ‡æ¿ã€‚
        </div>
        <div class="input-group">
            <label for="outputText">è¾“å‡ºç»“æœ (è§£ç æˆ–ç¼–ç )</label>
            <textarea id="outputText" readonly placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            <div id="statusMessage" class="error-message"></div>
        </div>
    </div>
</div>

<script>
    const inputText = document.getElementById('inputText');
    const outputText = document.getElementById('outputText');
    const encodingSelect = document.getElementById('encodingSelect');
    const statusMessage = document.getElementById('statusMessage');

    // Base64 å­—ç¬¦é›†çš„ç®€å•æ­£åˆ™æ£€æŸ¥
    const BASE64_REGEX = /^[A-Za-z0-9+/=]*$/;

    window.onload = function() {
        // ç›‘å¬å›è½¦é”®ï¼Œè§¦å‘æŸ¥è¯¢
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                b64Action();
            }
        });
        
        // ç›‘å¬åŒå‡»äº‹ä»¶ï¼Œå¤åˆ¶åˆ°å‰ªåˆ‡æ¿
        outputText.addEventListener('dblclick', function() {
            copyToClipboard(outputText.value);
        });
    }

    /**
     * å°†æ–‡æœ¬å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼Œå¹¶ç»™å‡ºåé¦ˆ
     * @param {string} text 
     */
    async function copyToClipboard(text) {
        if (!text) {
            statusMessage.textContent = 'âŒ å‰ªåˆ‡æ¿å¤åˆ¶å¤±è´¥ï¼šè¾“å‡ºæ¡†å†…å®¹ä¸ºç©ºã€‚';
            return;
        }
        
        try {
            // ä½¿ç”¨ç°ä»£ Clipboard API
            await navigator.clipboard.writeText(text);
            
            // æˆåŠŸåé¦ˆ
            const originalStatus = statusMessage.textContent;
            statusMessage.style.color = 'var(--success)';
            statusMessage.textContent = 'ğŸ“‹ å¤åˆ¶æˆåŠŸï¼å†…å®¹å·²å­˜å…¥å‰ªåˆ‡æ¿ã€‚';
            
            // å‡ ç§’åæ¢å¤åŸçŠ¶
            setTimeout(() => {
                statusMessage.style.color = 'var(--danger)';
                statusMessage.textContent = originalStatus;
            }, 3000);

        } catch (err) {
            // å¤±è´¥åé¦ˆ
            statusMessage.textContent = 'âŒ å‰ªåˆ‡æ¿å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶ã€‚';
            console.error('Copy failed: ', err);
            
            // å°è¯•æ—§æ–¹æ³•ï¼ˆé€‰ä¸­å†…å®¹å¹¶å¤åˆ¶ï¼‰ä½œä¸ºå¤‡ç”¨
            outputText.select();
            document.execCommand('copy');
        }
    }


    /**
     * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦å¯èƒ½æ˜¯æœ‰æ•ˆçš„ Base64 ç¼–ç 
     * @param {string} str 
     * @returns {boolean}
     */
    function isBase64(str) {
        if (!str || str.length === 0) return false;
        
        // 1. æ£€æŸ¥å­—ç¬¦é›†
        if (!BASE64_REGEX.test(str)) {
            return false;
        }

        // 2. æ£€æŸ¥é•¿åº¦æ˜¯å¦æ˜¯ 4 çš„å€æ•°
        if (str.length % 4 !== 0) {
            return false;
        }
        
        return true; 
    }

    /**
     * æ‰§è¡Œç¼–ç æˆ–è§£ç çš„ä¸»é€»è¾‘
     */
    function b64Action() {
        const input = inputText.value.trim();
        const encoding = encodingSelect.value;
        statusMessage.textContent = '';
        outputText.value = '';

        if (!input) {
            statusMessage.textContent = 'è¯·è¾“å…¥å†…å®¹ã€‚';
            return;
        }

        // æ ¸å¿ƒé€»è¾‘ï¼šå°è¯•è§£ç ã€‚å¦‚æœçœ‹èµ·æ¥åƒ Base64 ä¸”è§£ç æˆåŠŸï¼Œåˆ™è§£ç ï¼›å¦åˆ™ç¼–ç ã€‚
        let action = 'Encode';
        if (isBase64(input)) {
            action = 'Decode';
        }
        
        if (action === 'Decode') {
            try {
                const binaryString = atob(input);
                
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                const decoder = new TextDecoder(encoding);
                outputText.value = decoder.decode(bytes);
                statusMessage.textContent = `âœ… æˆåŠŸï¼šå·²æŒ‰ ${encoding} ç¼–ç è¿›è¡Œ Base64 è§£ç ã€‚`;

            } catch (e) {
                statusMessage.textContent = `âš ï¸ è§£ç å¤±è´¥ (${e.message})ï¼Œå°è¯•ç¼–ç ...`;
                encodeInput(input, encoding);
            }
        } else {
            encodeInput(input, encoding);
        }
    }
    
    /**
     * æ‰§è¡Œ Base64 ç¼–ç 
     * @param {string} input 
     * @param {string} encoding 
     */
    function encodeInput(input, encoding) {
        try {
            const encoder = new TextEncoder(encoding);
            const bytes = encoder.encode(input);
            
            let binaryString = '';
            for (let i = 0; i < bytes.length; i++) {
                binaryString += String.fromCharCode(bytes[i]);
            }
            
            outputText.value = btoa(binaryString);
            statusMessage.textContent = `âœ… æˆåŠŸï¼šå·²æŒ‰ ${encoding} ç¼–ç è¿›è¡Œ Base64 ç¼–ç ã€‚`;

        } catch (e) {
            statusMessage.textContent = `âŒ ç¼–ç å¤±è´¥ï¼šä¸æ”¯æŒ ${encoding} æˆ–æ•°æ®é”™è¯¯ (${e.message})ã€‚`;
        }
    }
</script>

</body>
</html>
