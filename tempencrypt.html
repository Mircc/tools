<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´æ—¶åŠ è§£å¯†å·¥å…· - å®‰å…¨ä¿¡æ¯ä¼ è¾“</title>
    <style>
        /* ç»Ÿä¸€çš„ç®€çº¦è®¾è®¡é£æ ¼ (ä¸æ­¤å‰é¡µé¢ä¿æŒä¸€è‡´) */
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-color: #334155;
            --header-color: #1e293b;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --error-bg: #fee2e2;
            --error-text: #991b1b;
            --info-bg: #eff6ff;
            --info-text: #1e40af;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 900px; margin: 0 auto; }
        
        h1 { 
            color: var(--header-color); 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 2rem;
        }

        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* ä¿¡æ¯æç¤ºæ  */
        .info-box {
            background: var(--info-bg);
            color: var(--info-text);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        .info-box p { margin: 5px 0; }
        .info-box strong { font-weight: 600; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-group { margin-bottom: 20px; }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--header-color);
        }

        textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            color: var(--text-color);
            font-family: monospace;
            transition: border-color 0.2s;
        }
        
        textarea { min-height: 180px; resize: vertical; }
        textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ç»“æœåŒºåŸŸ */
        .result-area {
            margin-top: 25px;
            display: none; 
        }
        
        .result-box {
            padding: 20px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid transparent;
            cursor: pointer; /* åŒå‡»å¤åˆ¶æç¤º */
        }
        
        .result-box:active {
            opacity: 0.9;
        }

        .result-success {
            background: var(--success-bg);
            color: var(--success-text);
            border-color: #86efac;
        }
        
        .result-error {
            background: var(--error-bg);
            color: var(--error-text);
            border-color: #fca5a5;
        }

        .result-title {
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
        }
        
        .result-info {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 10px;
        }

        /* å“åº”å¼ */
        @media (max-width: 640px) {
            .button-group { flex-direction: column; }
        }
        
        /* éšç§/ç¯å¢ƒè­¦å‘Š */
        .env-warning {
            background: #fff7ed;
            color: #9a3412;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #fdba74;
            display: none; 
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ä¸´æ—¶åŠ è§£å¯†å·¥å…·</h1>
    
    <div id="httpsWarning" class="env-warning">
        âš ï¸ <strong>å®‰å…¨è­¦å‘Šï¼š</strong> æ£€æµ‹åˆ°å½“å‰ç¯å¢ƒä¸å®‰å…¨ã€‚Web Crypto API éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒæ‰èƒ½è¿è¡Œã€‚è¯·åˆ‡æ¢åˆ°å®‰å…¨ç¯å¢ƒä½¿ç”¨ã€‚
    </div>

    <div class="card">
        <div class="info-box">
            <p>â€¢ <strong>å¯†æ–‡è¯†åˆ«å¤´ï¼š</strong> å¯†æ–‡ä»¥ `secxxx_` å¼€å¤´ï¼Œå·¥å…·å°†è‡ªåŠ¨è¯†åˆ«å¹¶åˆ‡æ¢ä¸ºè§£å¯†æ¨¡å¼ã€‚</p>
            <p>â€¢ <strong>å›è½¦é”®å“åº”ï¼š</strong> åœ¨è¾“å…¥æ¡†æŒ‰ä¸‹å›è½¦é”®å¯ç›´æ¥æ‰§è¡Œæ“ä½œã€‚</p>
            <p>â€¢ <strong>åŒå‡»å¤åˆ¶ï¼š</strong> åŒå‡»ç»“æœåŒºåŸŸå¯è‡ªåŠ¨å¤åˆ¶å†…å®¹ã€‚</p>
        </div>

        <div class="input-group">
            <label for="inputText">è¾“å…¥å†…å®¹ (æ˜æ–‡æˆ–å¯†æ–‡)</label>
            <textarea id="inputText" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦åŠ å¯†çš„æ•æ„Ÿä¿¡æ¯ï¼Œæˆ–è€…ç²˜è´´æ¥æ”¶åˆ°çš„å¯†æ–‡..."></textarea>
        </div>

        <div class="input-group">
            <label for="expireTime">è®¾ç½®æœ‰æ•ˆæœŸ (åŠ å¯†æ—¶æœ‰æ•ˆ)</label>
            <select id="expireTime">
                <option value="24">24 å°æ—¶ (1å¤©)</option>
                <option value="72" selected>72 å°æ—¶ (3å¤©)</option>
                <option value="168">168 å°æ—¶ (1å‘¨)</option>
                <option value="720">720 å°æ—¶ (1æœˆ)</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="smartBtn">ğŸ”’ åŠ å¯†ä¿¡æ¯</button>
        </div>

        <div id="resultContainer" class="result-area">
            <div id="resultBox" class="result-box">
                <span class="result-title" id="resultTitle">ç»“æœ</span>
                <div id="resultContent"></div>
                <div class="result-info" id="resultInfo">åŒå‡»å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿ã€‚</div>
            </div>
        </div>
    </div>
    
    <div style="text-align: center; color: #94a3b8; font-size: 0.85em; margin-top: 20px;">
        çº¯å‰ç«¯æœ¬åœ°åŠ å¯†å¤„ç† | æ— æ•°æ®ä¸Šä¼ æœåŠ¡å™¨ | å¯†é’¥å‘¨æœŸæ€§é”€æ¯
    </div>
</div>

<script>
    // --- å¸¸é‡ ---
    const CIPHER_PREFIX = 'secxxx_';
    const STATIC_SALT = 'static-salt-v1'; // ä¿æŒä¸å˜ï¼Œç”¨äº Key æ´¾ç”Ÿ

    // --- å…ƒç´ å¼•ç”¨ ---
    const inputText = document.getElementById('inputText');
    const expireTime = document.getElementById('expireTime');
    const smartBtn = document.getElementById('smartBtn');
    const resultContainer = document.getElementById('resultContainer');
    const resultBox = document.getElementById('resultBox');
    const resultTitle = document.getElementById('resultTitle');
    const resultContent = document.getElementById('resultContent');
    const resultInfo = document.getElementById('resultInfo');

    // --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

    /**
     * å°† ArrayBuffer è½¬æ¢ä¸º Base64URL å­—ç¬¦ä¸²
     * @param {ArrayBuffer} buffer 
     */
    function arrayBufferToBase64URL(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
    }

    /**
     * å°† Base64URL å­—ç¬¦ä¸²è½¬å› ArrayBuffer
     * @param {string} base64URL 
     */
    function base64URLToArrayBuffer(base64URL) {
        let base64 = base64URL.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) {
            base64 += '=';
        }
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }
    
    /**
     * å°†æ•°å­—ï¼ˆå°æ—¶ï¼‰è½¬æ¢ä¸º Big Endian å­—èŠ‚ï¼ˆ4 å­—èŠ‚æˆ– 2 å­—èŠ‚ï¼‰
     * @param {number} num 
     * @param {number} bytes 
     */
    function numberToBytes(num, bytes) {
        const buffer = new ArrayBuffer(bytes);
        const view = new DataView(buffer);
        if (bytes === 4) {
            view.setUint32(0, num, false); // Big Endian
        } else if (bytes === 2) {
            view.setUint16(0, num, false); // Big Endian
        }
        return new Uint8Array(buffer);
    }
    
    /**
     * ä»å­—èŠ‚è·å–æ•°å­—
     * @param {Uint8Array} bytes 
     * @param {number} bytesCount 
     */
    function bytesToNumber(bytes, bytesCount) {
        const view = new DataView(bytes.buffer, bytes.byteOffset, bytesCount);
        if (bytesCount === 4) {
            return view.getUint32(0, false); // Big Endian
        } else if (bytesCount === 2) {
            return view.getUint16(0, false); // Big Endian
        }
        return 0;
    }
    
    // --- 1. æ—¶é—´æ ¡éªŒ (å¤šæºå¢å¼º) ---

    // æƒå¨æ—¶é—´æºåˆ—è¡¨
    const TIME_APIS = [
        'https://worldtimeapi.org/api/ip',
        'https://worldtimeapi.org/api/timezone/Etc/UTC'
    ];
    
    /**
     * ä»å¤šä¸ªæƒå¨æ—¶é—´æœåŠ¡å™¨è·å–æ—¶é—´ï¼ˆå°æ—¶ä¸ºå•ä½ï¼‰
     */
    async function getAuthorityTimeInHours() {
        resultInfo.textContent = 'æ­£åœ¨è¿æ¥æƒå¨æ—¶é—´æœåŠ¡å™¨...';
        
        const fetchPromises = TIME_APIS.map(url => 
            fetch(url).then(response => {
                if (!response.ok) throw new Error(`API ${url} å“åº”å¼‚å¸¸`);
                return response.json();
            }).then(data => {
                return new Date(data.utc_datetime).getTime();
            })
        );

        let authorityTimeMs;
        try {
            // å“ªä¸ªå…ˆæˆåŠŸå°±ç”¨å“ªä¸ª
            authorityTimeMs = await Promise.race(fetchPromises);
        } catch (e) {
            console.error("æ‰€æœ‰æ—¶é—´APIéƒ½å¤±è´¥:", e);
            throw new Error('ç½‘ç»œæ—¶é—´æ ¡éªŒå¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ°æƒå¨æ—¶é—´æœåŠ¡å™¨ã€‚');
        }
        
        // æ ¡éªŒæœ¬åœ°æ—¶é—´å·®å¼‚ (å®¹å·® 24 å°æ—¶)
        const localTimeMs = Date.now();
        const diff = Math.abs(localTimeMs - authorityTimeMs) / (1000 * 3600);
        
        if (diff > 24) {
            throw new Error('æœ¬åœ°ç³»ç»Ÿæ—¶é—´åå·®è¿‡å¤§ (>24h)ã€‚è¯·æ ¡å‡†ç³»ç»Ÿæ—¶é—´ã€‚');
        }
        
        return Math.floor(authorityTimeMs / (1000 * 3600)); // è¿”å›è·ç¦» Epoch çš„å°æ—¶æ•°
    }

    // --- 2. å¯†é’¥ä¸åŠ è§£å¯† ---

    /**
     * ç”Ÿæˆå¯†é’¥
     * @param {number} expireHours æœ‰æ•ˆæœŸå°æ—¶æ•°
     * @param {number} currentAuthorityHour å½“å‰æƒå¨å°æ—¶æ•°
     */
    async function generateCryptoKey(expireHours, currentAuthorityHour) {
        // å¯†é’¥ç”Ÿæˆç®—æ³•ï¼šåŸºå‡†æ—¶é—´ = å½“å‰æ—¶é—´ / æœ‰æ•ˆæœŸ
        const keyBase = Math.floor(currentAuthorityHour / expireHours);
        const seed = `${keyBase}-${expireHours}`; 
        
        const encoder = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            encoder.encode(seed),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
        );
