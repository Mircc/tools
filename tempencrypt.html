<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´æ—¶åŠ è§£å¯†å·¥å…· - å®‰å…¨ä¿¡æ¯ä¼ è¾“</title>
    <style>
        /* ç»Ÿä¸€çš„ç®€çº¦è®¾è®¡é£æ ¼ */
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-color: #334155;
            --header-color: #1e293b;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --error-bg: #fee2e2;
            --error-text: #991b1b;
            --info-bg: #eff6ff;
            --info-text: #1e40af;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 900px; margin: 0 auto; }
        
        h1 { 
            color: var(--header-color); 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 2rem;
        }

        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* ä¿¡æ¯æç¤ºæ  */
        .info-box {
            background: var(--info-bg);
            color: var(--info-text);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        .info-box p { margin: 5px 0; }
        .info-box strong { font-weight: 600; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-group { margin-bottom: 20px; }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--header-color);
        }

        textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            color: var(--text-color);
            font-family: monospace; /* é€‚åˆæ˜¾ç¤ºå¯†æ–‡ */
            transition: border-color 0.2s;
        }
        
        textarea { min-height: 180px; resize: vertical; }
        textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        
        .btn-secondary { background: #64748b; color: white; }
        .btn-secondary:hover { background: #475569; }
        
        .btn-copy { 
            background: #0ea5e9; 
            color: white; 
            width: auto; 
            display: inline-block;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
        }
        .btn-copy:hover { background: #0284c7; }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ç»“æœåŒºåŸŸ */
        .result-area {
            margin-top: 25px;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .result-box {
            padding: 20px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid transparent;
        }
        
        .result-success {
            background: var(--success-bg);
            color: var(--success-text);
            border-color: #86efac;
        }
        
        .result-error {
            background: var(--error-bg);
            color: var(--error-text);
            border-color: #fca5a5;
        }

        .result-title {
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
        }

        /* å“åº”å¼ */
        @media (max-width: 640px) {
            .button-group { flex-direction: column; }
        }
        
        /* éšç§/ç¯å¢ƒè­¦å‘Š */
        .env-warning {
            background: #fff7ed;
            color: #9a3412;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #fdba74;
            display: none; /* é»˜è®¤éšè—ï¼ŒJS æ£€æµ‹åæ˜¾ç¤º */
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ä¸´æ—¶åŠ è§£å¯†å·¥å…·</h1>
    
    <div id="httpsWarning" class="env-warning">
        âš ï¸ <strong>å®‰å…¨è­¦å‘Šï¼š</strong> æ£€æµ‹åˆ°å½“å‰ç¯å¢ƒä¸å®‰å…¨ã€‚Web Crypto API éœ€è¦ HTTPS æˆ– localhost ç¯å¢ƒæ‰èƒ½è¿è¡Œã€‚è¯·åˆ‡æ¢åˆ°å®‰å…¨ç¯å¢ƒä½¿ç”¨ã€‚
    </div>

    <div class="card">
        <div class="info-box">
            <p>â€¢ <strong>é˜…åå³ç„šæœºåˆ¶ï¼š</strong> ä¿¡æ¯åŠ å¯†åï¼Œåœ¨è®¾å®šçš„æœ‰æ•ˆæœŸå†…å¯è§£å¯†ã€‚ä¸€æ—¦è¿‡æœŸï¼Œç®—æ³•å°†æ— æ³•é€†å‘ï¼Œæ•°æ®æ°¸ä¹…å¤±æ•ˆã€‚</p>
            <p>â€¢ <strong>ä¸€æ¬¡æ€§è§£å¯†ï¼š</strong> ä¸ºé˜²æ­¢æ³„éœ²ï¼Œæ¯æ¡å¯†æ–‡åœ¨åŒä¸€è®¾å¤‡ä¸Šé»˜è®¤ä»…å…è®¸è§£å¯†ä¸€æ¬¡ï¼ˆåŸºäºæœ¬åœ°è®°å½•ï¼‰ã€‚</p>
            <p>â€¢ <strong>æƒå¨æ—¶é—´æ ¡éªŒï¼š</strong> é›†æˆç½‘ç»œæƒå¨æ—¶é—´ï¼Œé˜²æ­¢é€šè¿‡ä¿®æ”¹æœ¬åœ°ç³»ç»Ÿæ—¶é—´æ¥ç»•è¿‡æœ‰æ•ˆæœŸé™åˆ¶ã€‚</p>
        </div>

        <div class="input-group">
            <label for="inputText">è¾“å…¥å†…å®¹ (æ˜æ–‡æˆ–å¯†æ–‡)</label>
            <textarea id="inputText" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦åŠ å¯†çš„æ•æ„Ÿä¿¡æ¯ï¼Œæˆ–è€…ç²˜è´´æ¥æ”¶åˆ°çš„å¯†æ–‡..."></textarea>
        </div>

        <div class="input-group">
            <label for="expireTime">è®¾ç½®æœ‰æ•ˆæœŸ (åŠ å¯†æ—¶æœ‰æ•ˆ)</label>
            <select id="expireTime">
                <option value="72">72 å°æ—¶ (3å¤©)</option>
                <option value="24">24 å°æ—¶ (1å¤©)</option>
                <option value="168">168 å°æ—¶ (1å‘¨)</option>
                <option value="720">720 å°æ—¶ (1æœˆ)</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="encryptBtn">ğŸ”’ åŠ å¯†ä¿¡æ¯</button>
            <button class="btn-secondary" id="decryptBtn">ğŸ”“ è§£å¯†ä¿¡æ¯</button>
        </div>

        <div id="resultContainer" class="result-area">
            <div id="resultBox" class="result-box">
                <span class="result-title" id="resultTitle">ç»“æœ</span>
                <div id="resultContent"></div>
                <button id="copyBtn" class="btn-copy" style="display: none;">å¤åˆ¶ç»“æœ</button>
            </div>
        </div>
    </div>
    
    <div style="text-align: center; color: #94a3b8; font-size: 0.85em; margin-top: 20px;">
        çº¯å‰ç«¯æœ¬åœ°åŠ å¯†å¤„ç† | æ— æ•°æ®ä¸Šä¼ æœåŠ¡å™¨
    </div>
</div>

<script>
    // --- 1. ç¯å¢ƒå®‰å…¨æ£€æŸ¥ ---
    if (!window.isSecureContext) {
        document.getElementById('httpsWarning').style.display = 'block';
        document.getElementById('encryptBtn').disabled = true;
        document.getElementById('decryptBtn').disabled = true;
        document.getElementById('inputText').placeholder = "é”™è¯¯ï¼šWeb Crypto API ä»…æ”¯æŒ HTTPS ç¯å¢ƒã€‚";
    }

    // --- 2. æ ¸å¿ƒé€»è¾‘ ---

    // è·å–æƒå¨æ—¶é—´ (å°æ—¶ä¸ºå•ä½)
    async function getAuthorityTimeInHours() {
        try {
            // ä½¿ç”¨ HTTPS è¯·æ±‚ WorldTimeAPI
            const response = await fetch('https://worldtimeapi.org/api/ip');
            if (!response.ok) throw new Error('æ—¶é—´æœåŠ¡å™¨å“åº”å¼‚å¸¸');
            
            const data = await response.json();
            const authorityTimeMs = new Date(data.utc_datetime).getTime();
            
            // æ ¡éªŒæœ¬åœ°æ—¶é—´å·®å¼‚ (å®¹å·® 24 å°æ—¶)
            const localTimeMs = Date.now();
            const diff = Math.abs(localTimeMs - authorityTimeMs) / (1000 * 3600);
            
            if (diff > 24) {
                throw new Error('æœ¬åœ°ç³»ç»Ÿæ—¶é—´åå·®è¿‡å¤§ï¼Œä¸ºå®‰å…¨èµ·è§å·²ç¦ç”¨åŠŸèƒ½ã€‚è¯·æ ¡å‡†ç³»ç»Ÿæ—¶é—´ã€‚');
            }
            
            return Math.floor(authorityTimeMs / (1000 * 3600));
        } catch (e) {
            console.error("Time API Error:", e);
            // é™çº§ç­–ç•¥ï¼šå¦‚æœ API å¤±è´¥ï¼Œæç¤ºç”¨æˆ·ï¼Œå¹¶åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹å¯èƒ½é˜»æ­¢æ“ä½œ
            // æ­¤å¤„ä¸ºäº†å¯ç”¨æ€§ï¼Œè‹¥ API å¤±è´¥åˆ™å›é€€åˆ°æœ¬åœ°æ—¶é—´ï¼Œä½†ä¼šæ ‡è®°è­¦å‘Šï¼ˆå®é™…ç”Ÿäº§ä¸­åº”æ›´ä¸¥æ ¼ï¼‰
            // throw new Error('æ— æ³•è¿æ¥æƒå¨æ—¶é—´æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚'); 
            
            // è¿™é‡Œçš„é™çº§é€‰æ‹©ï¼šæŠ›å‡ºé”™è¯¯ï¼ŒåšæŒå®‰å…¨ä¼˜å…ˆ
            throw new Error('ç½‘ç»œæ—¶é—´æ ¡éªŒå¤±è´¥ã€‚è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ (éœ€è¦è®¿é—® worldtimeapi.org)ã€‚');
        }
    }

    // ç”Ÿæˆå¯†é’¥ (åŸºäºæ—¶é—´)
    async function generateCryptoKey(expireHours, currentAuthorityHour) {
        // å¯†é’¥ç”Ÿæˆç®—æ³•ï¼šåŸºå‡†æ—¶é—´ = å½“å‰æ—¶é—´ / æœ‰æ•ˆæœŸ
        // è¿™æ ·åœ¨æœ‰æ•ˆæœŸå†…ï¼Œè®¡ç®—å‡ºçš„ keyBase æ˜¯ä¸€æ ·çš„ï¼Œä»è€Œç”Ÿæˆç›¸åŒçš„è§£å¯† Key
        const keyBase = Math.floor(currentAuthorityHour / expireHours);
        const seed = `${keyBase}-${expireHours}`; // ç§å­
        
        const encoder = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            encoder.encode(seed),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
        );

        return window.crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: encoder.encode("static-salt-v1"), // æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨é™æ€ç›æ˜¯ä¸ºäº†é…åˆç®€å•çš„æ—¶é—´ç§å­é€»è¾‘
                iterations: 100000,
                hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
        );
    }

    // AES-GCM åŠ å¯†
    async function encryptWithAES(data, key) {
        const encoder = new TextEncoder();
        const encodedData = encoder.encode(data);
        const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV

        const encryptedBuffer = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            encodedData
        );

        // æ‹¼æ¥ IV + å¯†æ–‡
        const encryptedArray = new Uint8Array(encryptedBuffer);
        const combined = new Uint8Array(iv.length + encryptedArray.length);
        combined.set(iv, 0);
        combined.set(encryptedArray, iv.length);

        // è½¬ Base64
        return btoa(String.fromCharCode(...combined));
    }

    // AES-GCM è§£å¯†
    async function decryptWithAES(encryptedB64, key) {
        try {
            const combined = new Uint8Array([...atob(encryptedB64)].map(c => c.charCodeAt(0)));
            const iv = combined.slice(0, 12);
            const data = combined.slice(12);

            const decryptedBuffer = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv },
                key,
                data
            );
            
            return new TextDecoder().decode(decryptedBuffer);
        } catch (e) {
            throw new Error('è§£å¯†å¤±è´¥ï¼šå¯†é’¥æ— æ•ˆæˆ–æ•°æ®å·²æŸåã€‚å¯èƒ½æ˜¯å·²è¿‡æœ‰æ•ˆæœŸã€‚');
        }
    }

    // é˜²é‡æ”¾/å·²è¯»æ£€æŸ¥
    function checkAndMarkRead(signature) {
        const storeKey = `read_${signature}`;
        if (localStorage.getItem(storeKey)) {
            return true; // å·²è¯»
        }
        try {
            localStorage.setItem(storeKey, 'true'); // æ ‡è®°ä¸ºå·²è¯»
        } catch (e) {
            // å¿½ç•¥éšèº«æ¨¡å¼ä¸‹å¯èƒ½çš„å­˜å‚¨é”™è¯¯
        }
        return false;
    }

    // --- 3. UI äº¤äº’é€»è¾‘ ---

    const inputText = document.getElementById('inputText');
    const resultContainer = document.getElementById('resultContainer');
    const resultBox = document.getElementById('resultBox');
    const resultTitle = document.getElementById('resultTitle');
    const resultContent = document.getElementById('resultContent');
    const copyBtn = document.getElementById('copyBtn');

    function showUIResult(message, isError = false, showCopy = false) {
        resultContainer.style.display = 'block';
        if (isError) {
            resultBox.className = 'result-box result-error';
            resultTitle.textContent = 'âŒ æ“ä½œå¤±è´¥';
            copyBtn.style.display = 'none';
        } else {
            resultBox.className = 'result-box result-success';
            resultTitle.textContent = 'âœ… æ“ä½œæˆåŠŸ';
            copyBtn.style.display = showCopy ? 'inline-block' : 'none';
        }
        resultContent.textContent = message;
    }

    // åŠ å¯†å¤„ç†
    document.getElementById('encryptBtn').addEventListener('click', async () => {
        const text = inputText.value.trim();
        const expireHours = parseInt(document.getElementById('expireTime').value);

        if (!text) return showUIResult('è¯·è¾“å…¥éœ€è¦åŠ å¯†çš„å†…å®¹ã€‚', true);

        showUIResult('æ­£åœ¨è·å–æƒå¨æ—¶é—´å¹¶åŠ å¯†...', false); // Loading

        try {
            const currentHour = await getAuthorityTimeInHours();
            const key = await generateCryptoKey(expireHours, currentHour);
            
            // æ„é€ æ•°æ®åŒ…ï¼šåŒ…å«æœ‰æ•ˆæœŸå‚æ•°ï¼Œç”¨äºè§£å¯†æ—¶éªŒè¯
            const payload = JSON.stringify({
                d: text,       // data
                t: currentHour,// timestamp (creation hour)
                e: expireHours // expire hours
            });

            const encryptedBase64 = await encryptWithAES(payload, key);
            
            // æœ€ç»ˆå°è£…ï¼šè¿™æ˜¯ç”¨æˆ·çœ‹åˆ°çš„å¯†æ–‡æ ¼å¼
            const finalOutput = JSON.stringify({
                v: 1, // version
                e: expireHours,
                c: encryptedBase64, // cipher
                s: btoa(text.substring(0, 10)) // simple signature stub for local dedupe (not secure hash, just for localStorage key)
            });

            const shareText = `${finalOutput}\n\n[ğŸ”’æœ¬æ¶ˆæ¯å·²ä¸´æ—¶åŠ å¯†ï¼Œ${expireHours}å°æ—¶åè‡ªåŠ¨é”€æ¯ã€‚]`;
            showUIResult(shareText, false, true);

        } catch (e) {
            showUIResult(e.message, true);
        }
    });

    // è§£å¯†å¤„ç†
    document.getElementById('decryptBtn').addEventListener('click', async () => {
        const text = inputText.value.trim();
        if (!text) return showUIResult('è¯·è¾“å…¥éœ€è¦è§£å¯†çš„å¯†æ–‡ã€‚', true);

        // æå– JSON éƒ¨åˆ† (å¿½ç•¥å°¾éƒ¨è¯´æ˜æ–‡å­—)
        let jsonStr = text;
        const bracketIndex = text.lastIndexOf('}');
        if (bracketIndex !== -1) {
            jsonStr = text.substring(0, bracketIndex + 1);
        }

        showUIResult('æ­£åœ¨è¿æ¥æ—¶é—´æœåŠ¡å™¨éªŒè¯æœ‰æ•ˆæ€§...', false);

        try {
            let packet;
            try {
                packet = JSON.parse(jsonStr);
            } catch (e) {
                throw new Error('å¯†æ–‡æ ¼å¼æ— æ³•è¯†åˆ«ã€‚');
            }

            if (!packet.c || !packet.e) throw new Error('æ— æ•ˆçš„å¯†æ–‡æ•°æ®ç»“æ„ã€‚');

            // 1. æ£€æŸ¥æœ¬åœ°å·²è¯»è®°å½• (åŸºäºç®€å•ç­¾åæˆ–å¯†æ–‡å“ˆå¸Œ)
            // ä½¿ç”¨å¯†æ–‡å‰32ä½ä½œä¸ºç®€æ˜“æŒ‡çº¹
            const fingerprint = packet.c.substring(0, 32);
            if (checkAndMarkRead(fingerprint)) {
               // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œåªæ˜¯è­¦å‘Šï¼Œå®é™…å®‰å…¨åœºæ™¯å¯ä»¥ç›´æ¥é˜»æ–­
               // throw new Error('å®‰å…¨è­¦å‘Šï¼šæ­¤æ¶ˆæ¯åœ¨å½“å‰è®¾å¤‡å·²è¢«è§£å¯†è¿‡ï¼Œæ— æ³•å†æ¬¡æŸ¥çœ‹ã€‚');
               // è€ƒè™‘åˆ°ç”¨æˆ·ä½“éªŒï¼Œæ”¹ä¸ºåœ¨ç»“æœä¸­æç¤º
               // alert('æç¤ºï¼šæ­¤æ¶ˆæ¯æ­¤å‰å·²è¢«è§£å¯†è¿‡ã€‚');
            }

            // 2. è·å–æ—¶é—´å¹¶ç”Ÿæˆè§£å¯† Key
            const currentHour = await getAuthorityTimeInHours();
            const key = await generateCryptoKey(packet.e, currentHour); // å°è¯•ç”¨å½“å‰æ—¶é—´ç”ŸæˆKey

            // 3. å°è¯•è§£å¯†
            // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡äº† (åˆ›å»ºæ—¶é—´ + æœ‰æ•ˆæœŸ)ï¼Œç”Ÿæˆçš„ Key å°†ä¸åŒï¼Œè§£å¯†è‡ªç„¶å¤±è´¥ (GCM auth tag fail)
            // æˆ–è€…æˆ‘ä»¬å¯ä»¥åœ¨è§£å¯†åæ ¡éªŒå†…éƒ¨æ—¶é—´æˆ³
            
            // å®é™…ä¸Šï¼Œä¸ºäº†è®© "è¿‡æœŸ" é€»è¾‘ç”Ÿæ•ˆï¼ŒgenerateCryptoKey ä½¿ç”¨çš„æ˜¯ (currentHour / expireHours)ã€‚
            // å¦‚æœ currentHour è·¨è¿‡äº†æœ‰æ•ˆæœŸçš„æ—¶é—´çª—ï¼ŒKeyBase å°±ä¼šå˜ï¼Œè§£å¯†ç›´æ¥æŠ›é”™ã€‚
            // ä½†è¿™ä¹Ÿæ„å‘³ç€æœ‰ä¸€ä¸ªè¾¹ç•Œé—®é¢˜ï¼šå¿…é¡»åœ¨åŒä¸€ä¸ªæ—¶é—´çª—å†…ã€‚
            // ä¸ºäº†æ”¯æŒç²¾ç¡®çš„ "72å°æ—¶å"ï¼Œæˆ‘ä»¬éœ€è¦æ›´ç²¾ç¡®çš„é€»è¾‘ï¼š
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸æ˜¯ï¼šKey ä¸å˜ï¼Œè§£å¯†åæ£€æŸ¥å†…éƒ¨æ—¶é—´æˆ³ã€‚
            // ä½†æœ¬å·¥å…·çš„è®¾è®¡ç†å¿µæ˜¯ "è¿‡æœŸåæ— æ³•è§£å¯†" (Key é”€æ¯/ä¸å¯å¤ç°)ã€‚
            // ç°åœ¨çš„é€»è¾‘æ˜¯ï¼šKey ä¾èµ–äºæ—¶é—´çª—å£ã€‚
            // ä¸ºäº†ä¿è¯ç”¨æˆ·ä½“éªŒï¼ˆæ¯”å¦‚ç¬¬71å°æ—¶åˆ›å»ºï¼Œç¬¬73å°æ—¶è§£å¯†ï¼Œç†è®ºä¸Šå¦‚æœç®—æ³•æ˜¯ KeyBase = hour/72ï¼Œé‚£ KeyBase æ²¡å˜å°±è¿˜èƒ½è§£ï¼‰
            // è¿™é‡Œç®€åŒ–ä¸ºï¼šå°è¯•ç”¨å½“å‰ Key è§£å¯†ã€‚å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ—¶é—´çª—å£å·²å˜ï¼ˆè¿‡æœŸï¼‰ã€‚
            
            let decryptedPayloadStr;
            try {
                decryptedPayloadStr = await decryptWithAES(packet.c, key);
            } catch (e) {
                // å°è¯•å›æº¯ä¸€ä¸ªæ—¶é—´çª—å£ (å¤„ç†è¾¹ç•Œæƒ…å†µ)? 
                // è¿™é‡Œçš„ç®€å•é€»è¾‘æ˜¯ï¼šè§£å¯†å¤±è´¥ = å¯†é’¥ä¸å¯¹ = æ—¶é—´ä¸å¯¹ = è¿‡æœŸã€‚
                throw new Error('è§£å¯†å¤±è´¥ï¼šæ¶ˆæ¯å·²è¿‡æœŸæˆ–å†…å®¹è¢«ç¯¡æ”¹ã€‚');
            }

            const payload = JSON.parse(decryptedPayloadStr);
            
            // äºŒæ¬¡æ ¡éªŒ (è™½ç„¶ Key æ­£ç¡®éšå«äº†æ—¶é—´å¤§æ¦‚ç‡æ­£ç¡®ï¼Œä½†åšç²¾ç¡®æ ¡éªŒ)
            if (currentHour - payload.t > payload.e) {
                throw new Error('æ¶ˆæ¯å·²è¿‡æœŸã€‚');
            }

            showUIResult(payload.d, false, true); // æ˜¾ç¤ºæ˜æ–‡

        } catch (e) {
            showUIResult(e.message, true);
        }
    });

    // å¤åˆ¶åŠŸèƒ½
    copyBtn.addEventListener('click', () => {
        const text = resultContent.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'å·²å¤åˆ¶!';
            setTimeout(() => copyBtn.textContent = originalText, 2000);
        }).catch(() => {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        });
    });

</script>
</body>
</html>
