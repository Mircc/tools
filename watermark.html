<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿å›¾åƒæ°´å°å·¥å…· - å®‰å…¨å·¥å…·ç®±</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-color: #334155;
            --header-color: #1e293b;
            --success-bg: #dcfce7;
            --success-text: #166534;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            margin: 0;
            line-height: 1.5;
        }

        /* --- Navbar --- */
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { font-weight: 700; font-size: 1.15rem; color: var(--primary); text-decoration: none; }
        .nav-links { display: flex; gap: 20px; }
        .nav-link { text-decoration: none; color: #64748b; font-weight: 500; font-size: 0.9rem; transition: color 0.2s; }
        .nav-link:hover { color: var(--primary); }
        .nav-link.active { color: var(--primary); font-weight: 600; }
        @media (max-width: 768px) { .nav-links { display: none; } }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
        .g-hd { text-align: center; margin-bottom: 30px; }
        h1 { color: #1e293b; margin-bottom: 10px; }

        .card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        
        .input-group { width: 100%; margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.9em; font-weight: 600; margin-bottom: 5px; color: #475569; }
        input[type="text"], select { width: 100%; height: 40px; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
        .color-input-container { display: flex; gap: 10px; }
        #fontColorPicker { border: 1px solid #e2e8f0; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; padding: 2px; }
        .range-container { margin-bottom: 1rem; }
        .range-input { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; cursor: pointer; margin-top: 5px; }
        .btn-primary { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; height: 40px; background: #2563eb; color: white; transition: all 0.2s; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-download { background: #0294a7 !important; }
        .upload-placeholder { border: 2px dashed #e2e8f0; border-radius: 6px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-area { position: relative; }
        .upload-area input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .preview-area { min-height: 250px; border: 1px solid #e2e8f0; border-radius: 6px; background: #e9ecef; display: flex; align-items: center; justify-content: center; overflow: hidden; max-height: 80vh; position: relative; }
        #myCanvas { max-width: 100%; max-height: 100%; display: none; }
        .privacy-tip { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--success-bg); color: var(--success-text); padding: 6px 15px; border-radius: 99px; font-size: 0.875rem; font-weight: 600; width: fit-content; margin: 0 auto; }
        .privacy-tip svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">ğŸ›¡ï¸ å®‰å…¨å·¥å…·ç®±</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">é¦–é¡µ</a>
            <a href="watermark.html" class="nav-link active">åœ¨çº¿æ°´å°</a>
            <a href="dns.html" class="nav-link">DNSæŸ¥è¯¢</a>
            <a href="jasonformat.html" class="nav-link">JSONå·¥å…·</a>
            <a href="base64.html" class="nav-link">Base64</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="g-hd">
        <h1>åœ¨çº¿å›¾åƒæ°´å°å·¥å…·</h1>
        <div class="privacy-tip">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            <span>100% éšç§ä¿æŠ¤ (çº¯æœ¬åœ°å¤„ç†)</span>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">æ°´å°è®¾ç½®</h2>
            <div class="input-group">
                <label>å›¾ç‰‡ä¸Šä¼ </label>
                <div class="upload-area">
                    <input id="imageFile" type="file" accept="image/png,image/jpeg,image/gif">
                    <div class="upload-placeholder">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ–¼ï¸</div>
                        <p style="font-weight: 600;">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ”¾å›¾ç‰‡</p>
                        <p id="imageStatus" style="font-size: 0.8em; color: #64748b;">æ”¯æŒå¤§å›¾é«˜æ€§èƒ½å¤„ç†</p>
                    </div>
                </div>
            </div>

            <h3 style="font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.8rem;">å‚æ•°è°ƒæ•´</h3>
            <div class="input-group">
                <label for="watermarkText">æ°´å°æ–‡å­—</label>
                <input id="watermarkText" type="text" value="è¯·å‹¿ç”¨äºå…¶ä»–ç”¨é€”">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label>é¢œè‰² (Hex)</label>
                    <div class="color-input-container">
                        <input type="text" id="fontColorText" value="#0000FF" maxlength="7">
                        <input type="color" id="fontColorPicker" value="#0000FF">
                    </div>
                </div>
                <div class="range-container">
                    <label>é€æ˜åº¦</label>
                    <input class="range-input" id="alphaRange" type="range" min="0.05" max="1" step="0.05" value="0.15">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="range-container">
                    <label>æ—‹è½¬è§’åº¦</label>
                    <input class="range-input" id="angleRange" type="range" min="-90" max="90" step="3" value="45">
                </div>
                <div class="range-container">
                    <label>å¹³é“ºé—´è·</label>
                    <input class="range-input" id="spaceRange" type="range" min="2" max="10" step="0.5" value="4">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="range-container">
                    <label>å­—ä½“å¤§å°</label>
                    <input class="range-input" id="sizeRange" type="range" min="0.5" max="5" step="0.1" value="1">
                </div>
                <div class="input-group">
                    <label>è¾“å‡ºæ ¼å¼</label>
                    <select id="formatSelect">
                        <option value="png">PNG (æ— æŸ/æ¨è)</option>
                        <option value="jpeg">JPG (æ–‡ä»¶æ›´å°)</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                <button class="btn-primary btn-download" id="downloadBtn" disabled style="width: 100%;">
                    â¬‡ï¸ é«˜æ¸…æ¸²æŸ“å¹¶ä¸‹è½½ (<span id="downloadFormat">PNG</span>)
                </button>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">å®æ—¶é¢„è§ˆ <span style="font-size:0.8em; color:#64748b; font-weight:normal">(ç¼©ç•¥å›¾)</span></h2>
            <div class="preview-area">
                <p id="previewPlaceholder" style="color: #9ca3af;">å›¾ç‰‡é¢„è§ˆåŒºåŸŸ</p>
                <canvas id="myCanvas"></canvas>
            </div>
            <p id="downloadHint" style="display: none; font-size: 0.9em; color: #64748b; text-align: center; margin-top: 10px;">é¢„è§ˆä»…æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œä¸‹è½½æ—¶å°†ç”ŸæˆåŸå›¾é«˜æ¸…æ°´å°</p>
        </div>
    </div>
</div>

<script>
    const PREVIEW_MAX_WIDTH = 800; 
    const BASE_FONT_SIZE_PX = 60; 

    const imageFile = document.getElementById('imageFile');
    const myCanvas = document.getElementById('myCanvas');
    const imageStatus = document.getElementById('imageStatus');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const downloadHint = document.getElementById('downloadHint');
    
    const watermarkText = document.getElementById('watermarkText');
    const fontColorText = document.getElementById('fontColorText');
    const fontColorPicker = document.getElementById('fontColorPicker');
    const alphaRange = document.getElementById('alphaRange');
    const angleRange = document.getElementById('angleRange');
    const spaceRange = document.getElementById('spaceRange');
    const sizeRange = document.getElementById('sizeRange');
    const formatSelect = document.getElementById('formatSelect');
    const downloadFormat = document.getElementById('downloadFormat');
    const downloadBtn = document.getElementById('downloadBtn');

    let originalImage = null; 
    let isImageLoaded = false;
    let renderTimeout = null; 

    function debounceRender() {
        if (renderTimeout) clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => { if (isImageLoaded) drawPreview(); }, 50);
    }

    window.onload = function() {
        imageFile.addEventListener('change', handleFileChange);
        const inputs = [watermarkText, fontColorText, fontColorPicker, alphaRange, angleRange, spaceRange, sizeRange];
        inputs.forEach(el => el.addEventListener('input', () => {
            if (el === fontColorPicker) fontColorText.value = el.value.toUpperCase();
            if (el === fontColorText && /^#[0-9A-F]{6}$/i.test(el.value)) fontColorPicker.value = el.value;
            debounceRender();
        }));
        formatSelect.addEventListener('change', () => downloadFormat.textContent = formatSelect.value.toUpperCase());
        downloadBtn.addEventListener('click', downloadHighRes);
    }

    function handleFileChange(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        originalImage = null;
        imageStatus.textContent = `è¯»å–ä¸­: ${file.name}...`;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                originalImage = img;
                isImageLoaded = true;
                imageStatus.textContent = `âœ… å·²åŠ è½½ (${img.naturalWidth} x ${img.naturalHeight})`;
                previewPlaceholder.style.display = 'none';
                myCanvas.style.display = 'block';
                downloadHint.style.display = 'block';
                downloadBtn.disabled = false;
                drawPreview();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function drawPreview() {
        if (!originalImage) return;
        let previewW = originalImage.naturalWidth;
        let previewH = originalImage.naturalHeight;
        if (previewW > PREVIEW_MAX_WIDTH) {
            const ratio = PREVIEW_MAX_WIDTH / previewW;
            previewW = PREVIEW_MAX_WIDTH;
            previewH = previewH * ratio;
        }
        myCanvas.width = previewW;
        myCanvas.height = previewH;
        
        const ctx = myCanvas.getContext('2d');
        ctx.clearRect(0, 0, previewW, previewH);
        ctx.drawImage(originalImage, 0, 0, previewW, previewH);
        const scale = previewW / originalImage.naturalWidth;
        renderWatermark(ctx, previewW, previewH, scale);
    }

    function renderWatermark(ctx, width, height, scale = 1) {
        const text = watermarkText.value;
        const color = fontColorText.value;
        const alpha = parseFloat(alphaRange.value);
        const angle = parseFloat(angleRange.value);
        const fontSize = (BASE_FONT_SIZE_PX * parseFloat(sizeRange.value)) * scale;
        const rgba = hexToRgba(color, alpha);

        ctx.font = `${fontSize}px Arial, sans-serif`;
        const textMetric = ctx.measureText(text);
        const unitW = textMetric.width + (textMetric.width * 0.5 * parseFloat(spaceRange.value));
        const unitH = fontSize + (fontSize * parseFloat(spaceRange.value));

        ctx.fillStyle = rgba;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.save();
        ctx.translate(width / 2, height / 2);
        ctx.rotate(angle * Math.PI / 180);
        ctx.translate(-width / 2, -height / 2);

        const diag = Math.sqrt(width*width + height*height);
        const offset = (diag - width) / 2;
        
        for (let y = -offset; y < height + offset; y += unitH) {
            const shift = (Math.floor((y + offset) / unitH) % 2 === 0) ? 0 : unitW / 2;
            for (let x = -offset - unitW; x < width + offset; x += unitW) {
                ctx.fillText(text, x + shift, y);
            }
        }
        ctx.restore();
    }

    function downloadHighRes() {
        if (!originalImage) return;
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'æ­£åœ¨æ¸²æŸ“...';
        
        setTimeout(() => {
            const hiResCanvas = document.createElement('canvas');
            hiResCanvas.width = originalImage.naturalWidth;
            hiResCanvas.height = originalImage.naturalHeight;
            const ctx = hiResCanvas.getContext('2d');
            ctx.drawImage(originalImage, 0, 0);
            renderWatermark(ctx, hiResCanvas.width, hiResCanvas.height, 1);
            
            const format = formatSelect.value;
            const link = document.createElement('a');
            link.download = `Watermark_${Date.now()}.${format}`;
            link.href = hiResCanvas.toDataURL(format === 'jpeg' ? 'image/jpeg' : 'image/png', 0.9);
            link.click();
            
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = `â¬‡ï¸ é«˜æ¸…æ¸²æŸ“å¹¶ä¸‹è½½ (<span id="downloadFormat">${format.toUpperCase()}</span>)`;
        }, 50);
    }

    function hexToRgba(hex, alpha) {
        hex = hex.trim().replace('#', '');
        return `rgba(${parseInt(hex.substring(0,2),16)}, ${parseInt(hex.substring(2,4),16)}, ${parseInt(hex.substring(4,6),16)}, ${alpha})`;
    }
</script>
</body>
</html>
