<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线 RESTful API 调试工具</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-color: #334155;
            --header-color: #1e293b;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --error-color: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: var(--header-color); text-align: center; margin-bottom: 20px; }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 992px) {
            .main-grid {
                grid-template-columns: 1fr 1.2fr; /* 结果区域稍宽 */
            }
        }
        
        .input-group { width: 100%; margin-bottom: 1rem; }
        
        .input-group label { 
            display: block; 
            font-size: 0.9em; 
            font-weight: 600; 
            margin-bottom: 5px; 
            color: #475569; 
        }

        input[type="text"], textarea, select, input[type="password"] {
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid var(--border); 
            border-radius: 6px;
            font-size: 14px; 
            box-sizing: border-box;
            background-color: var(--card);
            color: var(--text-color);
            transition: border-color 0.2s;
        }
        
        textarea { min-height: 150px; resize: vertical; font-family: monospace; }
        
        /* Method and URL Bar */
        .request-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        #methodSelect {
            flex-shrink: 0;
            width: 120px;
            font-weight: 600;
        }
        #urlInput {
            flex-grow: 1;
        }

        /* Buttons */
        .btn-primary { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px;
            font-weight: 600; 
            cursor: pointer; 
            white-space: nowrap;
            transition: all 0.2s;
            height: 40px;
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger {
            background: var(--error-color);
            color: white;
        }
        .btn-danger:hover { background: #b91c1c; }


        /* Dynamic Key-Value Pairs (Headers/Auth) */
        .key-value-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .key-value-row input {
            height: 40px;
        }
        .key-value-row input:first-child {
            width: 35%;
        }
        .key-value-row input:nth-child(2) {
            flex-grow: 1;
        }
        .key-value-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        /* Response Viewer Styling */
        .response-section h3 {
            font-size: 1.1em;
            color: var(--header-color);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        .response-viewer {
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 15px;
            border-radius: 6px;
            min-height: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }

        /* Status Display */
        #statusDisplay {
            font-weight: 700;
            font-size: 1.2em;
            padding: 5px 10px;
            border-radius: 6px;
            color: var(--card);
            background: #6b7280;
            display: inline-block;
            margin-left: 10px;
        }
        .status-2xx { background: #10b981 !important; } /* Green */
        .status-3xx { background: #f59e0b !important; } /* Yellow/Orange */
        .status-4xx { background: #f97316 !important; } /* Orange */
        .status-5xx { background: var(--error-color) !important; } /* Red */

        /* Auth/Body Tabs */
        .tab-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            background: transparent;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.1s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            font-weight: 600;
        }
        .tab-content {
            display: none;
            padding: 5px 0;
        }
        .tab-content.active {
            display: block;
        }
        
        /* 缓存状态提示 */
        #cacheStatus {
            font-size: 0.8em;
            color: #64748b;
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>在线 RESTful API 调试工具</h1>
    
    <div style="padding: 10px 15px; background: #fffbe7; border: 1px solid #fcd34d; border-radius: 6px; margin-bottom: 20px; font-size: 0.9em; color: #92400e;">
        ⚠️ **重要提示：** 此工具纯本地运行。若请求其他域名的 API，可能因浏览器 **CORS** 策略被阻止。如遇请求失败，请尝试在本地服务器环境中运行，或请求支持 CORS 的 API。
    </div>
    
    <p id="cacheStatus">配置已启用本地缓存，输入时自动保存。</p>

    <div class="main-grid">
        <div class="card" id="requestConfigCard"> <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1e293b;">请求配置</h2>

            <div style="margin-bottom: 1.5rem;">
                <label for="urlInput">URL 地址</label>
                <div class="request-bar">
                    <select id="methodSelect">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="HEAD">HEAD</option>
                    </select>
                    <input id="urlInput" type="text" placeholder="请输入 API URL (例如: https://jsonplaceholder.typicode.com/posts/1)" value="">
                    <button class="btn-primary" id="sendBtn">发送请求</button>
                </div>
            </div>

            <div class="tab-bar" id="requestTabs">
                <button class="tab-btn active" data-tab="headers">Headers</button>
                <button class="tab-btn" data-tab="auth">认证 (Auth)</button>
                <button class="tab-btn" data-tab="body">Body (主体)</button>
                <button class="tab-btn" data-tab="import">导入 JSON</button>
            </div>
            
            <div class="tab-content active" id="tab-headers">
                <div class="input-group">
                    <label for="customUAInput">User-Agent</label>
                    <input type="text" placeholder="Value (例如: custom-ua-client)" id="customUAInput" value="">
                </div>

                <h4 style="font-size: 1em; margin-top: 1rem; margin-bottom: 0.5rem;">自定义 Headers</h4>
                <div class="key-value-actions">
                    <button class="btn-secondary" id="addHeaderBtn">添加 Header</button>
                </div>
                <div id="headersContainer">
                    </div>
            </div>

            <div class="tab-content" id="tab-auth">
                <div class="input-group">
                    <label for="authTypeSelect">认证类型</label>
                    <select id="authTypeSelect" style="height: 40px;">
                        <option value="none">无认证</option>
                        <option value="bearer">Bearer Token (OAuth 2.0)</option>
                        <option value="basic">Basic Auth (用户名/密码)</option>
                    </select>
                </div>
                
                <div id="bearerTokenGroup" style="display: none;" class="input-group">
                    <label for="bearerTokenInput">Bearer Token</label>
                    <input type="text" id="bearerTokenInput" placeholder="请输入 Token (例如: eyJhbGciOiJIUzI1NiI...)" />
                </div>
                
                <div id="basicAuthGroup" style="display: none;">
                    <div class="input-group">
                        <label for="basicAuthUsername">用户名</label>
                        <input type="text" id="basicAuthUsername" placeholder="Username" />
                    </div>
                    <div class="input-group">
                        <label for="basicAuthPassword">密码</label>
                        <input type="password" id="basicAuthPassword" placeholder="Password" />
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="tab-body">
                <div class="input-group">
                    <label for="bodyTypeSelect">Body 类型</label>
                    <select id="bodyTypeSelect" style="height: 40px;">
                        <option value="none">无 Body</option>
                        <option value="json">JSON (application/json)</option>
                        <option value="text">纯文本 (text/plain)</option>
                        <option value="form">URL-Encoded 表单 (不建议在此处使用)</option>
                    </select>
                </div>
                <div class="input-group" id="bodyTextareaGroup">
                    <label for="requestBodyTextarea">请求主体内容</label>
                    <textarea id="requestBodyTextarea" placeholder='{"key": "value", "id": 1}'></textarea>
                </div>
            </div>
            
            <div class="tab-content" id="tab-import">
                <div class="input-group">
                    <label for="importJsonTextarea">粘贴 HTTPie/Postman JSON 请求配置</label>
                    <textarea id="importJsonTextarea" placeholder="请粘贴完整的 HTTPie/Postman 导出 JSON 文本到此处..."></textarea>
                </div>
                <button class="btn-primary" id="loadJsonBtn" style="width: 100%;">导入并应用配置</button>
                <p id="importStatus" style="margin-top: 10px; color: #f97316; font-size: 0.9em;">支持 HTTPie 1.0.0 格式。</p>
            </div>

        </div>

        <div class="card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1e293b;">响应结果</h2>

            <div style="display: flex; align-items: center;">
                <label style="font-weight: 600;">HTTP 状态码:</label>
                <span id="statusDisplay">--</span>
            </div>

            <div class="response-section">
                <h3>响应 Headers</h3>
                <pre class="response-viewer" id="responseHeaders"></pre>
            </div>

            <div class="response-section">
                <h3>响应 Body</h3>
                <pre class="response-viewer" id="responseBody">点击 "发送请求" 查看结果...</pre>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 常量与 DOM 元素引用 ---
    const STORAGE_KEY = 'apiDebuggerConfig'; // localStorage 键名
    const requestConfigCard = document.getElementById('requestConfigCard'); // 用于监听所有输入

    const sendBtn = document.getElementById('sendBtn');
    const urlInput = document.getElementById('urlInput');
    const methodSelect = document.getElementById('methodSelect');
    const headersContainer = document.getElementById('headersContainer');
    const addHeaderBtn = document.getElementById('addHeaderBtn');
    const customUAInput = document.getElementById('customUAInput');

    const authTypeSelect = document.getElementById('authTypeSelect');
    const bearerTokenGroup = document.getElementById('bearerTokenGroup');
    const bearerTokenInput = document.getElementById('bearerTokenInput');
    const basicAuthGroup = document.getElementById('basicAuthGroup');
    const basicAuthUsername = document.getElementById('basicAuthUsername');
    const basicAuthPassword = document.getElementById('basicAuthPassword');
    
    const bodyTypeSelect = document.getElementById('bodyTypeSelect');
    const requestBodyTextarea = document.getElementById('requestBodyTextarea');
    const bodyTextareaGroup = document.getElementById('bodyTextareaGroup');

    const statusDisplay = document.getElementById('statusDisplay');
    const responseHeaders = document.getElementById('responseHeaders');
    const responseBody = document.getElementById('responseBody');
    const requestTabs = document.getElementById('requestTabs');
    
    // Import elements
    const importJsonTextarea = document.getElementById('importJsonTextarea');
    const loadJsonBtn = document.getElementById('loadJsonBtn');
    const importStatus = document.getElementById('importStatus');

    // --- 辅助函数：去抖动 (Debounce) ---
    // 防止频繁的输入事件导致过度写入 localStorage
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // --- 配置保存/加载核心逻辑 (New) ---

    /**
     * 收集所有配置项并保存到 localStorage。
     */
    function saveConfiguration() {
        // 1. 收集动态 Header
        const dynamicHeaders = [];
        const rows = headersContainer.querySelectorAll('.key-value-row');
        rows.forEach(row => {
            const keyInput = row.children[0];
            const valueInput = row.children[1];
            dynamicHeaders.push({
                key: keyInput.value,
                value: valueInput.value
            });
        });

        // 2. 收集所有配置数据
        const config = {
            url: urlInput.value,
            method: methodSelect.value,
            customUA: customUAInput.value,
            dynamicHeaders: dynamicHeaders,
            
            authType: authTypeSelect.value,
            bearerToken: bearerTokenInput.value,
            basicUsername: basicAuthUsername.value,
            // 注意：出于安全考虑，密码通常不应保存在 localStorage 中。
            // 但为了实现用户的要求，此处仅在本地保存，并提示用户。
            basicPassword: basicAuthPassword.value, 
            
            bodyType: bodyTypeSelect.value,
            requestBody: requestBodyTextarea.value
        };

        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
        } catch (e) {
            console.error('无法保存配置到本地缓存:', e);
        }
    }

    /**
     * 从 localStorage 加载配置并应用到表单。
     */
    function loadConfiguration() {
        try {
            const savedConfig = localStorage.getItem(STORAGE_KEY);
            if (!savedConfig) {
                // 如果没有保存的配置，则应用默认配置
                applyDefaultConfiguration();
                return;
            }

            const config = JSON.parse(savedConfig);

            // 1. 应用 URL 和 Method
            urlInput.value = config.url || '';
            methodSelect.value = config.method || 'GET';
            
            // 2. 应用 Headers
            customUAInput.value = config.customUA || '';
            clearDynamicHeaders();
            if (config.dynamicHeaders && Array.isArray(config.dynamicHeaders)) {
                config.dynamicHeaders.forEach(header => {
                    addHeaderRow(header.key, header.value);
                });
            } else {
                // 确保默认 Header 存在
                addHeaderRow('Accept', 'application/json, text/plain, */*');
            }

            // 3. 应用 Auth
            authTypeSelect.value = config.authType || 'none';
            bearerTokenInput.value = config.bearerToken || '';
            basicAuthUsername.value = config.basicUsername || '';
            basicAuthPassword.value = config.basicPassword || ''; // 再次提醒：注意本地密码存储的风险
            updateAuthFields();

            // 4. 应用 Body
            bodyTypeSelect.value = config.bodyType || 'none';
            requestBodyTextarea.value = config.requestBody || '';
            updateBodyFields();

        } catch (e) {
            console.error('加载本地配置失败:', e);
            localStorage.removeItem(STORAGE_KEY); // 清除损坏的配置
            applyDefaultConfiguration();
        }
    }
    
    function applyDefaultConfiguration() {
        // 设置默认值
        urlInput.value = 'https://jsonplaceholder.typicode.com/posts/1';
        methodSelect.value = 'GET';
        customUAInput.value = 'REST-API-Client/1.0 (Web Debugger)';
        authTypeSelect.value = 'none';
        bodyTypeSelect.value = 'none';
        
        clearDynamicHeaders();
        addHeaderRow('Accept', 'application/json, text/plain, */*');
        
        updateAuthFields();
        updateBodyFields();
    }


    // --- 初始化和事件监听 ---

    // 使用去抖动包装保存函数，延迟 500ms 执行
    const debouncedSaveConfiguration = debounce(saveConfiguration, 500);

    window.onload = function() {
        // 1. 页面加载时：尝试加载配置
        loadConfiguration();

        // 2. 监听所有配置输入变化，自动保存
        // 'input' 适用于文本和范围；'change' 适用于 select 和 checkbox
        requestConfigCard.addEventListener('input', debouncedSaveConfiguration);
        requestConfigCard.addEventListener('change', debouncedSaveConfiguration);
        
        // 3. 发送按钮点击事件
        sendBtn.addEventListener('click', sendRequest);
        
        // 4. 动态 Header 管理 (添加/移除时需要重新保存配置)
        addHeaderBtn.addEventListener('click', () => {
            addHeaderRow();
            saveConfiguration(); // 立即保存新的 Header 结构
        });
        
        // 5. 认证类型切换事件
        authTypeSelect.addEventListener('change', updateAuthFields);
        updateAuthFields(); 

        // 6. Body 类型切换事件
        bodyTypeSelect.addEventListener('change', updateBodyFields);
        updateBodyFields(); 
        
        // 7. 选项卡切换事件
        requestTabs.addEventListener('click', handleTabSwitch);
        
        // 8. 导入 JSON 按钮事件
        loadJsonBtn.addEventListener('click', () => {
            handleImportJson();
            saveConfiguration(); // 导入成功后立即保存配置
        });
        
    }
    
    // --- 选项卡切换逻辑 (不变) ---
    function handleTabSwitch(e) {
        if (!e.target.classList.contains('tab-btn')) return;

        const targetTab = e.target.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        e.target.classList.add('active');
        document.getElementById(`tab-${targetTab}`).classList.add('active');
        
        if (targetTab === 'import') {
            importStatus.textContent = '支持 HTTPie 1.0.0 格式。';
            importStatus.style.color = '#f97316';
        }
    }

    // --- 动态 Header 逻辑 (略有修改：添加移除时需调用 saveConfiguration) ---

    function addHeaderRow(key = '', value = '') {
        const row = document.createElement('div');
        row.className = 'key-value-row';
        row.innerHTML = `
            <input type="text" placeholder="Key (例如: Content-Type)" value="${key}">
            <input type="text" placeholder="Value" value="${value}">
            <button class="btn-danger">移除</button>
        `;
        
        // 移除按钮事件
        const removeBtn = row.querySelector('.btn-danger');
        removeBtn.addEventListener('click', () => {
            row.remove();
            saveConfiguration(); // 移除后立即保存
        });
        
        // 监听新增行的输入变化
        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', debouncedSaveConfiguration);
        });

        headersContainer.appendChild(row);
    }
    
    function clearDynamicHeaders() {
        headersContainer.innerHTML = ''; 
    }

    function getCustomHeaders() {
        const headers = {};
        
        // 1. 获取 User-Agent
        const ua = customUAInput.value.trim();
        if (ua) {
            headers['User-Agent'] = ua;
        }

        // 2. 获取自定义 Headers
        const rows = headersContainer.querySelectorAll('.key-value-row');
        
        rows.forEach(row => {
            const keyInput = row.children[0];
            const valueInput = row.children[1];
            
            const key = keyInput.value.trim();
            const value = valueInput.value.trim();

            if (key && value) {
                headers[key] = value;
            }
        });
        return headers;
    }
    
    // --- 认证字段切换逻辑 (不变) ---
    function updateAuthFields() {
        const authType = authTypeSelect.value;
        bearerTokenGroup.style.display = 'none';
        basicAuthGroup.style.display = 'none';

        if (authType === 'bearer') {
            bearerTokenGroup.style.display = 'block';
        } else if (authType === 'basic') {
            basicAuthGroup.style.display = 'block';
        }
    }
    
    // --- Body 字段切换逻辑 (不变) ---
    function updateBodyFields() {
        const bodyType = bodyTypeSelect.value;
        if (bodyType === 'none') {
            bodyTextareaGroup.style.display = 'none';
        } else {
            bodyTextareaGroup.style.display = 'block';
        }
    }


    // --- 导入 JSON 核心逻辑 (不变) ---
    function handleImportJson() {
        const jsonString = importJsonTextarea.value.trim();
        if (!jsonString) {
            importStatus.textContent = '❌ 请粘贴 HTTPie/Postman JSON 文本。';
            importStatus.style.color = '#dc2626';
            return;
        }
        
        try {
            const data = JSON.parse(jsonString);
            loadRequestFromHttpieJson(data);
            
            importStatus.textContent = '✅ 配置导入成功！请检查 Headers 和 Body 标签页。';
            importStatus.style.color = '#166534';
            
            document.querySelector('.tab-btn[data-tab="headers"]').click();

        } catch (e) {
            importStatus.textContent = `❌ JSON 解析失败，请检查格式。错误: ${e.message}`;
            importStatus.style.color = '#dc2626';
        }
    }
    
    function loadRequestFromHttpieJson(data) {
        const entry = data.entry;
        if (!entry) throw new Error('JSON 格式错误：缺少 "entry" 字段。');

        urlInput.value = entry.url || '';
        methodSelect.value = entry.method.toUpperCase() || 'GET';
        
        // Headers
        clearDynamicHeaders();
        // 导入时，优先使用导入的 User-Agent，如果没有则保留当前或使用默认
        customUAInput.value = getHeaderValue(entry.headers, 'User-Agent') || customUAInput.value;
        
        if (entry.headers && Array.isArray(entry.headers)) {
            entry.headers.forEach(header => {
                // 排除 User-Agent，因为它有专门的输入框
                if (header.name.toLowerCase() !== 'user-agent') {
                    addHeaderRow(header.name, header.value);
                }
            });
        }
        
        // Auth
        if (entry.auth && entry.auth.type) {
            const type = entry.auth.type.toLowerCase();
            if (type === 'bearer' && entry.auth.token) {
                authTypeSelect.value = 'bearer';
                bearerTokenInput.value = entry.auth.token;
            } else if (type === 'basic' && (entry.auth.username || entry.auth.password)) {
                authTypeSelect.value = 'basic';
                basicAuthUsername.value = entry.auth.username || '';
                basicAuthPassword.value = entry.auth.password || '';
            } else {
                authTypeSelect.value = 'none';
            }
            updateAuthFields();
        }


        // Body
        const body = entry.body;
        if (body) {
            if (body.type === 'text' && body.text && body.text.value) {
                const format = (body.text.format || '').toLowerCase();
                if (format.includes('json')) {
                    bodyTypeSelect.value = 'json';
                } else if (format.includes('text')) {
                    bodyTypeSelect.value = 'text';
                } else {
                    bodyTypeSelect.value = 'none';
                }
                
                requestBodyTextarea.value = body.text.value;
                
            } else if (body.type === 'form' && body.form && body.form.fields.length > 0) {
                 bodyTypeSelect.value = 'form';
                 requestBodyTextarea.value = JSON.stringify(body.form.fields, null, 2);
                 alert('Body 包含 Form 字段，已将其 JSON 格式内容填充到 Body 文本区。请确保 Headers 中的 Content-Type 正确。');

            } else {
                bodyTypeSelect.value = 'none';
                requestBodyTextarea.value = '';
            }
            updateBodyFields();
        }
    }
    
    function getHeaderValue(headersArray, key) {
        if (!Array.isArray(headersArray)) return null;
        const found = headersArray.find(h => h.name.toLowerCase() === key.toLowerCase());
        return found ? found.value : null;
    }


    // --- 核心请求逻辑 (不变) ---

    async function sendRequest() {
        const url = urlInput.value.trim();
        const method = methodSelect.value;
        
        if (!url) {
            alert('URL 不能为空！');
            return;
        }

        // 1. 准备请求选项
        const requestOptions = {
            method: method,
            headers: getCustomHeaders(),
        };

        // 2. 处理认证 (Auth)
        const authType = authTypeSelect.value;
        if (authType === 'bearer') {
            const token = bearerTokenInput.value.trim();
            if (token) {
                requestOptions.headers['Authorization'] = `Bearer ${token}`;
            }
        } else if (authType === 'basic') {
            const username = basicAuthUsername.value;
            const password = basicAuthPassword.value;
            if (username || password) {
                const encoded = btoa(`${username}:${password}`);
                requestOptions.headers['Authorization'] = `Basic ${encoded}`;
            }
        }
        
        // 3. 处理 Body
        const bodyType = bodyTypeSelect.value;
        const bodyContent = requestBodyTextarea.value;
        
        if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method) && bodyType !== 'none') {
            requestOptions.body = bodyContent;
        }

        // 4. 清空和更新状态
        updateStatus('--', '');
        responseHeaders.textContent = '正在发送请求...';
        responseBody.textContent = '等待服务器响应...';
        sendBtn.disabled = true;

        try {
            const response = await fetch(url, requestOptions);
            
            // 5. 处理状态码
            updateStatus(response.status, response.statusText);

            // 6. 处理响应 Headers
            let headerText = '';
            for (const [key, value] of response.headers.entries()) {
                headerText += `${key}: ${value}\n`;
            }
            responseHeaders.textContent = headerText || '(无响应头部)';

            // 7. 处理响应 Body
            let bodyText;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                try {
                    const json = await response.json();
                    bodyText = JSON.stringify(json, null, 2);
                } catch (e) {
                    bodyText = await response.text();
                    bodyText = `JSON 解析失败。原始内容:\n${bodyText}`;
                }
            } else {
                bodyText = await response.text();
            }

            responseBody.textContent = bodyText || '(无响应主体)';

        } catch (error) {
            console.error('Fetch Error:', error);
            updateStatus('ERR', 'Network Error');
            responseHeaders.textContent = '无法获取 Headers。';
            responseBody.textContent = `请求失败：可能是网络错误、URL 错误，或最常见的原因是 **CORS 跨域策略**阻止了请求。\n\n错误信息: ${error.message}`;

        } finally {
            sendBtn.disabled = false;
        }
    }

    // --- 辅助函数：更新状态显示 (不变) ---
    function updateStatus(status, statusText) {
        statusDisplay.textContent = `${status}${statusText ? ' ' + statusText : ''}`;
        statusDisplay.className = ''; 
        
        if (status === 'ERR') {
            statusDisplay.classList.add('status-5xx');
        } else if (typeof status === 'number') {
            const statusClass = Math.floor(status / 100);
            statusDisplay.classList.add(`status-${statusClass}xx`);
        }
    }
</script>
</body>
</html>
